<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  
  <!-- Primary Meta Tags -->
  <title>Vehicle Cost of Ownership Calculator - True Cost Analysis</title>
  <meta name="title" content="Vehicle Cost of Ownership Calculator - True Cost Analysis" />
  <meta name="description" content="Calculate the true cost of owning a vehicle including depreciation, financing, and equity. Compare lease vs buy options with real 2026 pricing data for 30 brands." />
  <meta name="keywords" content="car cost calculator, vehicle ownership cost, lease vs buy calculator, car depreciation calculator, auto loan calculator, true cost of ownership" />
  <meta name="author" content="Vehicle Cost Calculator" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Vehicle Cost of Ownership Calculator" />
  <meta property="og:description" content="Calculate the true cost of owning a vehicle. Includes depreciation, financing, lease comparison, and credit impact analysis." />
  <meta property="og:image" content="https://yoursite.com/preview.png" />
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:title" content="Vehicle Cost of Ownership Calculator" />
  <meta property="twitter:description" content="Calculate the true cost of owning a vehicle. Free tool with real 2026 pricing data." />
  
  <!-- PWA / Mobile -->
  <meta name="theme-color" content="#0f172a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Car Cost Calc" />
  
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöó</text></svg>" />
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * { box-sizing: border-box; }
    
    html {
      scroll-behavior: smooth;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      margin: 0;
      padding: 0;
      line-height: 1.6;
      background: #0f172a;
      min-height: 100vh;
      color: #e2e8f0;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Animated Gradient Background */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(100, 149, 237, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
      animation: gradientShift 20s ease infinite;
      z-index: -1;
    }
    
    @keyframes gradientShift {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(5%, -5%) rotate(120deg); }
      66% { transform: translate(-5%, 5%) rotate(240deg); }
    }
    
    .wrap { 
      max-width: 1280px;
      margin: 0 auto;
      padding: 60px 24px;
      position: relative;
      z-index: 1;
    }
    
    /* Hero Header with Glow Effect */
    h1 { 
      margin: 0 0 12px;
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, #6495ED 0%, #8b5cf6 50%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.03em;
      position: relative;
      animation: fadeInUp 0.8s ease-out;
      text-align: center;
    }
    
    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 4px;
      background: linear-gradient(90deg, transparent, #6495ED, transparent);
      border-radius: 2px;
      animation: glowPulse 2s ease-in-out infinite;
    }
    
    @keyframes glowPulse {
      0%, 100% { opacity: 0.5; box-shadow: 0 0 20px rgba(100, 149, 237, 0.5); }
      50% { opacity: 1; box-shadow: 0 0 40px rgba(100, 149, 237, 0.8); }
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .subtitle { 
      color: #94a3b8;
      font-size: 18px;
      margin-bottom: 48px;
      font-weight: 400;
      line-height: 1.6;
      animation: fadeInUp 0.8s ease-out 0.2s backwards;
      text-align: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .grid { 
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
    }
    
    /* Glassmorphism Cards with Hover Effects */
    .card { 
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(100, 149, 237, 0.2);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.6s ease-out backwards;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(100, 149, 237, 0.1) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 
        0 20px 60px rgba(100, 149, 237, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border-color: rgba(100, 149, 237, 0.4);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    /* Stagger card animations */
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    .card:nth-child(5) { animation-delay: 0.5s; }
    
    .card h2 { 
      margin: 0 0 24px;
      font-size: 20px;
      font-weight: 700;
      color: #f1f5f9;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    label { 
      display: block;
      font-size: 13px;
      color: #94a3b8;
      margin: 0 0 10px;
      font-weight: 600;
      letter-spacing: -0.01em;
      transition: color 0.2s ease;
    }
    
    input, select { 
      width: 100%;
      padding: 14px 16px;
      border: 2px solid rgba(100, 149, 237, 0.2);
      border-radius: 12px;
      font-size: 15px;
      background: rgba(15, 23, 42, 0.6);
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: #f1f5f9;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }
    
    input:focus, select:focus { 
      outline: none;
      border-color: #6495ED;
      background: rgba(15, 23, 42, 0.8);
      box-shadow: 
        0 0 0 4px rgba(100, 149, 237, 0.15),
        0 8px 24px rgba(100, 149, 237, 0.2);
      transform: translateY(-2px);
    }
    
    input:hover, select:hover {
      border-color: rgba(100, 149, 237, 0.4);
    }
    
    .col-2 { grid-column: span 2; }
    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }
    
    /* Premium Button Styles */
    button { 
      padding: 16px 32px;
      border: 0;
      border-radius: 14px;
      font-size: 15px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Inter', sans-serif;
      letter-spacing: -0.01em;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }
    
    button:active::before {
      width: 300px;
      height: 300px;
    }
    
    .btn { 
      background: linear-gradient(135deg, #6495ED 0%, #5a7fd6 100%);
      color: #ffffff;
      box-shadow: 
        0 4px 20px rgba(100, 149, 237, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .btn:hover { 
      transform: translateY(-3px);
      box-shadow: 
        0 12px 40px rgba(100, 149, 237, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .btn:active {
      transform: translateY(-1px);
    }
    
    .btn-secondary { 
      background: rgba(100, 149, 237, 0.1);
      color: #6495ED;
      border: 2px solid rgba(100, 149, 237, 0.3);
      backdrop-filter: blur(10px);
    }
    
    .btn-secondary:hover { 
      background: rgba(100, 149, 237, 0.2);
      border-color: #6495ED;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(100, 149, 237, 0.3);
    }
    
    .muted { 
      color: #64748b;
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
      font-weight: 400;
    }
    
    .out { 
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
      margin-top: 24px;
    }
    
    /* Animated KPI Cards */
    .kpi { 
      border: 2px solid rgba(100, 149, 237, 0.2);
      border-radius: 16px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.4) 100%);
      backdrop-filter: blur(10px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .kpi::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(100, 149, 237, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease, transform 0.4s ease;
      pointer-events: none;
    }
    
    .kpi:hover {
      border-color: rgba(100, 149, 237, 0.5);
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 12px 40px rgba(100, 149, 237, 0.3);
    }
    
    .kpi:hover::after {
      opacity: 1;
      transform: translate(-25%, -25%);
    }
    
    .kpi h3 { 
      margin: 0 0 14px;
      font-size: 11px;
      color: #94a3b8;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .kpi .val { 
      font-size: 32px;
      font-weight: 800;
      color: #f1f5f9;
      letter-spacing: -0.02em;
      line-height: 1.1;
      transition: all 0.3s ease;
    }
    
    .kpi:hover .val {
      transform: scale(1.05);
    }
    
    .kpi.positive .val { 
      color: #10b981;
      text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
      animation: valueGlow 2s ease-in-out infinite;
    }
    
    .kpi.negative .val { 
      color: #ef4444;
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
      animation: valueGlow 2s ease-in-out infinite;
    }
    
    @keyframes valueGlow {
      0%, 100% { text-shadow: 0 0 20px currentColor; }
      50% { text-shadow: 0 0 30px currentColor, 0 0 40px currentColor; }
    }
    
    .kpi .sub { 
      font-size: 12px;
      color: #64748b;
      margin-top: 10px;
      font-weight: 500;
      line-height: 1.5;
    }
    
    table { 
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
    }
    
    th, td { 
      text-align: left;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(100, 149, 237, 0.1);
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    th { 
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(30, 41, 59, 0.3) 100%);
      font-weight: 700;
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    
    th:first-child {
      border-top-left-radius: 12px;
    }
    
    th:last-child {
      border-top-right-radius: 12px;
    }
    
    tr:hover td { 
      background: rgba(100, 149, 237, 0.05);
      transform: scale(1.01);
    }
    
    tr:last-child td:first-child {
      border-bottom-left-radius: 12px;
    }
    
    tr:last-child td:last-child {
      border-bottom-right-radius: 12px;
    }
    
    td:first-child {
      font-weight: 600;
      color: #cbd5e1;
    }
    
    .warn { 
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
      border: 2px solid rgba(251, 191, 36, 0.4);
      padding: 18px 24px;
      border-radius: 14px;
      font-size: 14px;
      color: #fef3c7;
      margin-top: 20px;
      font-weight: 500;
      line-height: 1.7;
      box-shadow: 0 8px 24px rgba(251, 191, 36, 0.2);
      animation: slideIn 0.5s ease-out;
    }
    
    .info { 
      background: linear-gradient(135deg, rgba(100, 149, 237, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
      border: 2px solid rgba(100, 149, 237, 0.4);
      padding: 18px 24px;
      border-radius: 14px;
      font-size: 14px;
      color: #dbeafe;
      margin-top: 20px;
      font-weight: 500;
      line-height: 1.7;
      box-shadow: 0 8px 24px rgba(100, 149, 237, 0.2);
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .chart-container { 
      width: 100%;
      height: 400px;
      position: relative;
      margin-top: 20px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.6) 0%, rgba(30, 41, 59, 0.4) 100%);
      border-radius: 16px;
      padding: 24px;
      border: 2px solid rgba(100, 149, 237, 0.2);
    }
    
    canvas { 
      border-radius: 12px;
    }
    
    .scenario-grid { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .scenario-card { 
      border: 2px solid rgba(100, 149, 237, 0.2);
      border-radius: 18px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.5) 100%);
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .scenario-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(100, 149, 237, 0.1) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    
    .scenario-card:hover { 
      border-color: #6495ED;
      box-shadow: 0 16px 48px rgba(100, 149, 237, 0.3);
      transform: translateY(-8px) scale(1.02);
    }
    
    .scenario-card:hover::before {
      opacity: 1;
    }
    
    .scenario-card.active { 
      border-color: #6495ED;
      background: linear-gradient(135deg, rgba(100, 149, 237, 0.2) 0%, rgba(100, 149, 237, 0.1) 100%);
      box-shadow: 0 12px 40px rgba(100, 149, 237, 0.4);
    }
    
    .scenario-card h4 { 
      margin: 0 0 12px;
      font-size: 15px;
      font-weight: 700;
      color: #f1f5f9;
      letter-spacing: -0.01em;
    }
    
    .scenario-card .scenario-val { 
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.02em;
      transition: transform 0.3s ease;
    }
    
    .scenario-card:hover .scenario-val {
      transform: scale(1.08);
    }
    
    .scenario-card .scenario-sub { 
      font-size: 12px;
      color: #94a3b8;
      margin-top: 8px;
      font-weight: 500;
    }
    
    /* Hero Cost Section - Premium Styling */
    .hero-cost-card {
      background: linear-gradient(135deg, rgba(100, 149, 237, 0.3) 0%, rgba(139, 92, 246, 0.3) 100%);
      border: 2px solid rgba(100, 149, 237, 0.5);
      box-shadow: 
        0 24px 60px rgba(100, 149, 237, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      margin-bottom: 40px;
      position: relative;
    }
    
    .hero-cost-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(100, 149, 237, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: 24px;
    }
    
    .hero-cost-card:hover::before {
      opacity: 1;
    }
    
    .hero-cost-card h2 {
      color: #f1f5f9;
      font-size: 24px;
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .hero-cost-card .kpi {
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(100, 149, 237, 0.3);
    }
    
    .hero-cost-card .kpi:hover {
      background: rgba(15, 23, 42, 0.6);
      border-color: rgba(100, 149, 237, 0.6);
    }
    
    .hero-cost-card .kpi h3 {
      color: #cbd5e1;
    }
    
    .hero-cost-card .kpi .val {
      color: #f1f5f9;
      text-shadow: 0 4px 20px rgba(100, 149, 237, 0.4);
      font-size: 36px;
    }
    
    .hero-cost-card .kpi .sub {
      color: #94a3b8;
    }
    
    .hero-cost-card .kpi.positive {
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.4);
    }
    
    .hero-cost-card .kpi.negative {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.4);
    }
    
    /* Net Cost of Ownership Hero Styling - THE STAR OF THE SHOW */
    #netCostKpi {
      background: linear-gradient(135deg, rgba(100, 149, 237, 0.4) 0%, rgba(139, 92, 246, 0.4) 100%);
      border: 3px solid rgba(100, 149, 237, 0.8);
      box-shadow: 
        0 0 60px rgba(100, 149, 237, 0.6),
        0 0 100px rgba(100, 149, 237, 0.4),
        0 12px 40px rgba(100, 149, 237, 0.5),
        inset 0 2px 0 rgba(255, 255, 255, 0.3);
      animation: netCostGlow 3s ease-in-out infinite;
      position: relative;
      overflow: visible;
    }
    
    @keyframes netCostGlow {
      0%, 100% { 
        box-shadow: 
          0 0 60px rgba(100, 149, 237, 0.6),
          0 0 100px rgba(100, 149, 237, 0.4),
          0 12px 40px rgba(100, 149, 237, 0.5),
          inset 0 2px 0 rgba(255, 255, 255, 0.3);
      }
      50% { 
        box-shadow: 
          0 0 80px rgba(100, 149, 237, 0.8),
          0 0 140px rgba(100, 149, 237, 0.6),
          0 16px 50px rgba(100, 149, 237, 0.7),
          inset 0 2px 0 rgba(255, 255, 255, 0.4);
      }
    }
    
    #netCostKpi::before {
      content: '‚≠ê';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 24px;
      animation: starPulse 2s ease-in-out infinite;
      filter: drop-shadow(0 0 10px rgba(100, 149, 237, 0.8));
    }
    
    @keyframes starPulse {
      0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.8; }
      50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
    }
    
    #netCostKpi h3 {
      color: #dbeafe !important;
      font-size: 13px !important;
      letter-spacing: 0.15em !important;
      text-shadow: 0 2px 8px rgba(100, 149, 237, 0.5);
    }
    
    #netCostKpi .val {
      font-size: 48px !important;
      color: #ffffff !important;
      text-shadow: 
        0 0 30px rgba(100, 149, 237, 1),
        0 0 60px rgba(100, 149, 237, 0.8),
        0 4px 20px rgba(100, 149, 237, 0.6) !important;
      animation: valueShine 3s ease-in-out infinite;
    }
    
    @keyframes valueShine {
      0%, 100% { 
        text-shadow: 
          0 0 30px rgba(100, 149, 237, 1),
          0 0 60px rgba(100, 149, 237, 0.8),
          0 4px 20px rgba(100, 149, 237, 0.6);
      }
      50% { 
        text-shadow: 
          0 0 40px rgba(100, 149, 237, 1),
          0 0 80px rgba(139, 92, 246, 1),
          0 6px 30px rgba(100, 149, 237, 0.8);
      }
    }
    
    #netCostKpi .sub {
      color: #bfdbfe !important;
      font-weight: 600 !important;
      font-size: 13px !important;
    }
    
    #netCostKpi:hover {
      border-color: rgba(100, 149, 237, 1);
      transform: translateY(-8px) scale(1.03);
      box-shadow: 
        0 0 80px rgba(100, 149, 237, 0.8),
        0 0 120px rgba(100, 149, 237, 0.6),
        0 20px 60px rgba(100, 149, 237, 0.7),
        inset 0 2px 0 rgba(255, 255, 255, 0.4);
    }
    
    /* Tab Button Styles */
    .tab-btn:hover {
      color: #6495ED;
      background: rgba(100, 149, 237, 0.1);
    }
    
    .tab-btn.active {
      color: #6495ED;
      border-bottom-color: #6495ED !important;
    }
    
    /* Scroll Animation Classes */
    .fade-in-up {
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.6s ease-out forwards;
    }
    
    /* ================================
       RESPONSIVE DESIGN - MOBILE FIRST
       ================================ */
    
    /* Tablets and small laptops (600px - 900px) */
    @media (max-width: 900px) {
      .wrap { 
        padding: 40px 20px; 
        max-width: 100%;
      }
      
      h1 { 
        font-size: 36px; 
        letter-spacing: -0.02em;
      }
      
      .subtitle {
        font-size: 16px;
        margin-bottom: 36px;
      }
      
      /* Two-column layout for tablets */
      .col-2 { grid-column: span 6; }
      .col-3 { grid-column: span 6; }
      .col-4 { grid-column: span 6; }
      .col-6 { grid-column: span 12; }
      .col-8 { grid-column: span 12; }
      
      .card {
        padding: 24px;
        margin-bottom: 20px;
      }
      
      /* KPI boxes - 2 columns on tablets */
      .kpi.col-4 { grid-column: span 6; }
      .kpi.col-6 { grid-column: span 12; }
      
      .kpi .val {
        font-size: 28px;
      }
      
      #netCostKpi .val {
        font-size: 40px !important;
      }
      
      .chart-container { 
        height: 350px; 
        padding: 20px;
      }
      
      /* Scenario cards adapt */
      .scenario-grid {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      
      /* Tab buttons slightly smaller */
      .tab-btn {
        padding: 12px 20px !important;
        font-size: 14px !important;
      }
      
      /* Vehicle comparison cards */
      #vehicleComparisonGrid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
    }
    
    /* Mobile phones (up to 600px) */
    @media (max-width: 600px) {
      body {
        font-size: 15px;
      }
      
      .wrap { 
        padding: 24px 16px;
      }
      
      h1 { 
        font-size: 28px;
        margin-bottom: 8px;
        line-height: 1.2;
      }
      
      h1::after {
        width: 80px;
        bottom: -8px;
      }
      
      .subtitle {
        font-size: 14px;
        margin-bottom: 28px;
        line-height: 1.5;
      }
      
      /* Everything stacks on mobile */
      .col-2, .col-3, .col-4, .col-6, .col-8, .col-12 { 
        grid-column: span 12; 
      }
      
      .card {
        padding: 20px;
        margin-bottom: 16px;
        border-radius: 20px;
      }
      
      .card h2 {
        font-size: 18px;
        margin-bottom: 20px;
      }
      
      /* Input fields larger for mobile */
      input, select {
        padding: 14px 16px;
        font-size: 16px; /* Prevents iOS zoom */
        border-radius: 12px;
      }
      
      label {
        font-size: 13px;
        margin-bottom: 8px;
      }
      
      .muted {
        font-size: 11px;
      }
      
      /* Buttons more prominent on mobile */
      button {
        padding: 16px 28px;
        font-size: 15px;
        border-radius: 12px;
        width: 100%;
        margin-bottom: 12px;
      }
      
      .btn-secondary {
        margin-left: 0 !important;
      }
      
      /* KPI boxes stack and get bigger on mobile */
      .kpi {
        padding: 20px;
        grid-column: span 12 !important;
      }
      
      .kpi .val {
        font-size: 32px;
      }
      
      #netCostKpi {
        padding: 24px;
      }
      
      #netCostKpi .val {
        font-size: 42px !important;
      }
      
      #netCostKpi h3 {
        font-size: 12px !important;
      }
      
      .hero-cost-card {
        padding: 24px;
      }
      
      .hero-cost-card h2 {
        font-size: 20px;
      }
      
      /* Chart optimized for mobile */
      .chart-container { 
        height: 280px; 
        padding: 16px;
      }
      
      /* Table improvements for mobile */
      table {
        font-size: 13px;
      }
      
      th, td {
        padding: 12px 10px;
        font-size: 13px;
      }
      
      th {
        font-size: 11px;
      }
      
      /* Scenario cards full width on mobile */
      .scenario-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .scenario-card {
        padding: 20px;
      }
      
      .scenario-card h4 {
        font-size: 14px;
      }
      
      .scenario-card .scenario-val {
        font-size: 24px;
      }
      
      /* Tab navigation horizontal scroll on mobile */
      #tabNav > div {
        flex-direction: column;
        gap: 8px;
        border-bottom: none;
      }
      
      .tab-btn {
        padding: 14px 20px !important;
        font-size: 14px !important;
        white-space: nowrap;
        width: 100%;
        border-radius: 12px !important;
        border: 2px solid rgba(100, 149, 237, 0.3) !important;
        border-bottom: 2px solid rgba(100, 149, 237, 0.3) !important;
        background: rgba(30, 41, 59, 0.6) !important;
      }
      
      .tab-btn.active {
        background: linear-gradient(135deg, rgba(100, 149, 237, 0.3) 0%, rgba(139, 92, 246, 0.3) 100%) !important;
        border-color: #6495ED !important;
        box-shadow: 0 4px 20px rgba(100, 149, 237, 0.4);
      }
      
      /* Vehicle comparison optimized for mobile */
      #vehicleComparisonGrid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      /* Info/warning messages better on mobile */
      .warn, .info {
        padding: 16px 18px;
        font-size: 13px;
        border-radius: 12px;
        line-height: 1.6;
      }
      
      /* Reduce animation complexity on mobile for performance */
      .kpi:hover {
        transform: translateY(-4px) scale(1.01);
      }
      
      .card:hover {
        transform: translateY(-4px);
      }
      
      /* Net Cost glow effect slightly reduced on mobile */
      #netCostKpi::before {
        font-size: 20px;
        top: -8px;
        right: -8px;
      }
    }
    
    /* Extra small phones (up to 375px) */
    @media (max-width: 375px) {
      h1 {
        font-size: 24px;
      }
      
      .subtitle {
        font-size: 13px;
      }
      
      .card {
        padding: 16px;
      }
      
      .kpi {
        padding: 16px;
      }
      
      .kpi .val {
        font-size: 28px;
      }
      
      #netCostKpi .val {
        font-size: 36px !important;
      }
      
      .tab-btn {
        padding: 10px 16px !important;
        font-size: 12px !important;
      }
      
      button {
        padding: 14px 24px;
        font-size: 14px;
      }
    }
    
    /* ================================
       TOUCH OPTIMIZATION
       ================================ */
    
    /* Minimum tap target size (44x44px) for accessibility */
    @media (hover: none) and (pointer: coarse) {
      /* Touch device detection */
      
      button {
        min-height: 44px;
        min-width: 44px;
      }
      
      input, select {
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .tab-btn {
        min-height: 48px;
      }
      
      /* Checkbox and radio buttons larger */
      input[type="checkbox"],
      input[type="radio"] {
        min-width: 24px;
        min-height: 24px;
        cursor: pointer;
      }
      
      /* Remove hover effects on touch devices, replace with active states */
      .card:hover {
        transform: none;
      }
      
      .card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }
      
      button:hover {
        transform: none;
      }
      
      button:active {
        transform: scale(0.96);
        transition: transform 0.1s ease;
      }
      
      .kpi:hover {
        transform: none;
        border-color: rgba(100, 149, 237, 0.2);
      }
      
      .kpi:active {
        transform: scale(0.98);
        border-color: rgba(100, 149, 237, 0.5);
        transition: all 0.1s ease;
      }
      
      .scenario-card:hover {
        transform: none;
      }
      
      .scenario-card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }
      
      input:hover, select:hover {
        border-color: rgba(100, 149, 237, 0.2);
      }
      
      input:active, select:active {
        border-color: #6495ED;
      }
      
      /* Better focus states for touch */
      input:focus, select:focus {
        outline: none;
        border-color: #6495ED;
        box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.15);
      }
      
      /* Touch-friendly table rows */
      tr:hover td {
        background: transparent;
      }
      
      tr:active td {
        background: rgba(100, 149, 237, 0.05);
      }
      
      /* Disable complex animations on touch for performance */
      .kpi .val {
        animation: none;
      }
      
      #netCostKpi {
        animation: none;
      }
      
      #netCostKpi .val {
        animation: none;
      }
      
      /* Better tap target for labels with checkboxes */
      label {
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(100, 149, 237, 0.1);
        min-height: 44px;
        display: flex;
        align-items: center;
      }
      
      /* Prevent text selection on buttons and interactive elements */
      button, .tab-btn, .scenario-card {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: rgba(100, 149, 237, 0.2);
      }
      
      /* Smooth momentum scrolling on iOS */
      * {
        -webkit-overflow-scrolling: touch;
      }
      
      /* Better active feedback for tab buttons */
      .tab-btn:active {
        transform: scale(0.97);
      }
    }
    
    /* ================================
       FINAL POLISH & REFINEMENTS
       ================================ */
    
    /* Smooth scrolling for tab switching */
    html {
      scroll-behavior: smooth;
    }
    
    /* Reduced motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      html {
        scroll-behavior: auto;
      }
    }
    
    /* Performance: Reduce blur on low-end devices */
    @media (max-width: 600px) {
      .card,
      .kpi,
      input,
      select,
      button {
        backdrop-filter: blur(10px); /* Reduced from 20px */
      }
    }
    
    /* Text overflow handling for long vehicle names */
    .scenario-card h4,
    #vehicleComparisonGrid h3 {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Number formatting - prevent overflow */
    .kpi .val,
    .scenario-val {
      overflow-wrap: break-word;
      word-break: break-word;
    }
    
    /* Smooth tab switching transitions */
    #output,
    #scenarioOutput,
    #vehiclesOutput {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(10px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    /* Loading state for calculate button */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }
    
    /* Focus visible for keyboard navigation */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    .tab-btn:focus-visible {
      outline: 3px solid #6495ED;
      outline-offset: 2px;
    }
    
    /* Better empty state styling */
    #noVehiclesMessage {
      animation: fadeInUp 0.6s ease-out;
    }
    
    /* Smooth height transitions for collapsible elements */
    #operatingCostsKpi,
    #insuranceField,
    #maintenanceField,
    #registrationField {
      transition: all 0.3s ease-in-out;
    }
    
    /* Better link styling if any links are added */
    a {
      color: #6495ED;
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    a:hover {
      color: #8b5cf6;
      text-decoration: underline;
    }
    
    /* Improve table responsiveness on very small screens */
    @media (max-width: 375px) {
      table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      th, td {
        white-space: nowrap;
      }
    }
    
    /* Better contrast for accessibility */
    .muted {
      color: #94a3b8; /* Improved from #64748b for better contrast */
    }
    
    /* Success/Error states for future use */
    .success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
      border: 2px solid rgba(16, 185, 129, 0.4);
      color: #d1fae5;
      padding: 16px 24px;
      border-radius: 14px;
      animation: slideIn 0.5s ease-out;
    }
    
    .error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
      border: 2px solid rgba(239, 68, 68, 0.4);
      color: #fecaca;
      padding: 16px 24px;
      border-radius: 14px;
      animation: slideIn 0.5s ease-out;
    }
    
    /* Optimize rendering performance */
    .card,
    .kpi,
    .scenario-card,
    button {
      will-change: transform;
      transform: translateZ(0); /* Hardware acceleration */
    }
    
    /* Print styles for when users want to save */
    @media print {
      body {
        background: white;
        color: black;
      }
      
      .card {
        border: 1px solid #ccc;
        box-shadow: none;
        page-break-inside: avoid;
      }
      
      button,
      #tabNav,
      .btn,
      .btn-secondary {
        display: none;
      }
      
      #output {
        display: block !important;
      }
      
      h1, h2 {
        color: black;
        text-shadow: none;
      }
    }
    
    /* Skeleton loading state placeholder (for future async operations) */
    .skeleton {
      background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.1) 25%, 
        rgba(255, 255, 255, 0.2) 50%, 
        rgba(255, 255, 255, 0.1) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Safe area for notched phones (iPhone X+) */
    @supports (padding: max(0px)) {
      body {
        padding-left: max(0px, env(safe-area-inset-left));
        padding-right: max(0px, env(safe-area-inset-right));
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1 id="mainTitle" style="opacity: 0;">üöó Vehicle Cost of Ownership Calculator</h1>
  <div class="subtitle">Calculate your true cost of ownership: what you'll actually spend to own this vehicle after accounting for depreciation and loan payoff</div>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .fade-animated {
      animation: fadeIn 0.8s ease-out forwards;
    }
    
    /* Respect user's motion preferences */
    @media (prefers-reduced-motion: reduce) {
      .fade-animated {
        animation: none;
        opacity: 1 !important;
      }
    }
    
    /* Fallback for browsers that don't support animations */
    @supports not (animation: fadeIn 0.8s ease-out forwards) {
      #mainTitle {
        opacity: 1 !important;
      }
    }
  </style>
      
  </style>
  
  <script>
    // Simple fade-in on page load with fallback
    function triggerFadeIn() {
      const title = document.getElementById('mainTitle');
      if (title && !title.classList.contains('fade-animated')) {
        title.classList.add('fade-animated');
      }
    }
    
    // Try on load
    window.addEventListener('load', triggerFadeIn);
    
    // Fallback: trigger after 100ms if load hasn't fired
    setTimeout(triggerFadeIn, 100);
    
    // Extra fallback: trigger immediately if document is already loaded
    if (document.readyState === 'complete') {
      triggerFadeIn();
    }
  </script>

  <!-- VEHICLE INFO -->
  <div class="card">
    <h2>Vehicle Information</h2>
    <div class="grid">
      <div class="col-3">
        <label>Year</label>
        <select id="year">
          <option value="2027">2027</option>
          <option value="2026" selected>2026</option>
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
          <option value="2019">2019</option>
          <option value="2018">2018</option>
          <option value="2017">2017</option>
          <option value="2016">2016</option>
          <option value="2015">2015</option>
        </select>
        <div class="muted">New: MSRP | Used: Depreciated value + market premium</div>
      </div>
      <div class="col-3">
        <label>Make</label>
        <select id="make">
          <option value="">Select Make...</option>
          <option value="Acura">Acura</option>
          <option value="Audi">Audi</option>
          <option value="BMW">BMW</option>
          <option value="Buick">Buick</option>
          <option value="Cadillac">Cadillac</option>
          <option value="Chevrolet">Chevrolet</option>
          <option value="Chrysler">Chrysler</option>
          <option value="Dodge">Dodge</option>
          <option value="Ford">Ford</option>
          <option value="GMC">GMC</option>
          <option value="Genesis">Genesis</option>
          <option value="Honda">Honda</option>
          <option value="Hyundai" selected>Hyundai</option>
          <option value="Infiniti">Infiniti</option>
          <option value="Jeep">Jeep</option>
          <option value="Kia">Kia</option>
          <option value="Lexus">Lexus</option>
          <option value="Lincoln">Lincoln</option>
          <option value="Mazda">Mazda</option>
          <option value="Mercedes-Benz">Mercedes-Benz</option>
          <option value="Mini">Mini</option>
          <option value="Mitsubishi">Mitsubishi</option>
          <option value="Nissan">Nissan</option>
          <option value="Porsche">Porsche</option>
          <option value="Ram">Ram</option>
          <option value="Subaru">Subaru</option>
          <option value="Tesla">Tesla</option>
          <option value="Toyota">Toyota</option>
          <option value="Volkswagen">Volkswagen</option>
          <option value="Volvo">Volvo</option>
        </select>
      </div>
      <div class="col-3">
        <label>Model</label>
        <select id="model">
          <option value="">Select Make First...</option>
        </select>
      </div>
      <div class="col-3">
        <label>Trim</label>
        <select id="trim">
          <option value="">Select Model First...</option>
        </select>
        <div class="muted">Auto-calculated using depreciation model + 7% market premium</div>
      </div>
      <div class="col-3">
        <label>Current Odometer (miles)</label>
        <input id="currentMileage" type="number" inputmode="decimal" min="0" step="100" value="0" />
        <div class="muted">Current mileage on vehicle</div>
      </div>
    </div>
  </div>

  <!-- PURCHASE & FINANCING -->
  <div class="card">
    <h2>Purchase & Financing</h2>
    <div class="grid">
      <div class="col-3">
        <label>Purchase Price ($)</label>
        <input id="price" type="number" inputmode="decimal" inputmode="decimal" min="0" step="100" value="52000" />
        <div class="muted">Auto-populated, but you can edit manually</div>
      </div>
      <div class="col-3">
        <label>Down Payment ($)</label>
        <input id="down" type="number" inputmode="decimal" min="0" step="100" value="5000" />
        <div class="muted">Amount paid upfront</div>
      </div>
      <div class="col-3">
        <label>Loan APR (%)</label>
        <input id="apr" type="number" inputmode="decimal" min="0" step="0.01" value="6.49" />
        <div class="muted">Annual percentage rate</div>
      </div>
      <div class="col-3">
        <label>Loan Term (months)</label>
        <input id="term" type="number" inputmode="decimal" min="1" step="1" value="60" />
        <div class="muted">Typically 36, 60, or 72 months</div>
      </div>
      <div class="col-3">
        <label>Credit Score (Optional) üîí</label>
        <input id="creditScore" type="number" inputmode="decimal" min="300" max="850" step="1" placeholder="300-850" />
        <div class="muted" id="creditTierText">Private - used for rate estimates only</div>
      </div>
    </div>
  </div>

  <!-- DEPRECIATION & MILEAGE -->
  <div class="card">
    <h2>Exit Analysis (When You Sell/Trade)</h2>
    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #6495ED; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
      <p style="margin: 0; font-size: 13px; color: #0c4a6e; font-weight: 500; line-height: 1.5;">
        ‚ÑπÔ∏è This is your <strong>exit point</strong> ‚Äî when you plan to sell or trade the vehicle. All cost calculations are based on this timeframe.
      </p>
    </div>
    <div class="grid">
      <div class="col-3">
        <label>Exit Point (years)</label>
        <input id="years" type="number" inputmode="decimal" min="0" step="0.5" value="3" />
        <div class="muted">When you plan to sell or trade this vehicle</div>
      </div>
      <div class="col-3">
        <label>Odometer at Exit (miles)</label>
        <input id="mileageAtAnalysis" type="number" inputmode="decimal" min="0" step="100" value="0" />
        <div class="muted">Projected mileage when you sell/trade</div>
      </div>
      <div class="col-3">
        <label>Segment Calibration</label>
        <select id="segment">
          <option value="">Select vehicle first...</option>
          <option value="TRUCK_FULLSIZE">Full-Size Truck</option>
          <option value="TRUCK_MIDSIZE">Mid-Size Truck</option>
          <option value="SUV_FULLSIZE">Full-Size SUV</option>
          <option value="SUV_MIDSIZE">Mid-Size SUV</option>
          <option value="SUV_COMPACT">Compact SUV</option>
          <option value="SEDAN_LUXURY">Luxury Sedan</option>
          <option value="SEDAN_MIDSIZE">Mid-Size Sedan</option>
          <option value="SEDAN_COMPACT">Compact Sedan</option>
          <option value="SEDAN_SUBCOMPACT">Subcompact Sedan</option>
          <option value="SPORTS_CAR">Sports Car</option>
          <option value="SPORTS_EXOTIC">Exotic/Supercar</option>
          <option value="MINIVAN">Minivan</option>
          <option value="EV_MAINSTREAM">Electric Vehicle (Mainstream)</option>
          <option value="EV_PREMIUM">Electric Vehicle (Premium)</option>
          <option value="HYBRID">Hybrid</option>
        </select>
        <div class="muted">Auto-filled based on model selection</div>
      </div>
      <div class="col-3">
        <label>Condition Adjustment (%)</label>
        <input id="condAdj" type="number" inputmode="decimal" min="-50" max="7.5" step="0.5" value="0.0" />
        <div class="muted">+ for excellent, ‚àí for poor condition</div>
      </div>
      <div class="col-12">
        <label>Post-Year-5 Annual Depreciation (%)</label>
        <input id="post5" type="number" inputmode="decimal" min="0" max="50" step="0.5" value="8.5" style="max-width: 200px;" />
        <div class="muted">Applied to years beyond 5</div>
      </div>
    </div>
  </div>

  <!-- MARKET FACTORS -->
  <div class="card">
    <h2>Market Factors & Additional Costs</h2>
    <div class="grid">
      <div class="col-3">
        <label>Trade-In Discount vs Private Sale (%)</label>
        <input id="tradeDisc" type="number" inputmode="decimal" min="0" max="40" step="0.5" value="12.0" />
        <div class="muted">Typical range: 8‚Äì15% depending on dealer margin</div>
      </div>
      <div class="col-3">
        <label>Extra Monthly Payment ($)</label>
        <input id="extraPmt" type="number" inputmode="decimal" min="0" step="50" value="0" />
        <div class="muted">Additional principal payment per month</div>
      </div>
      <div class="col-3">
        <label>Exit Timeline (years)</label>
        <input id="maxPeriod" type="number" inputmode="decimal" min="1" max="15" step="1" value="8" />
        <div class="muted">Chart timeline showing exit options</div>
      </div>
      <div class="col-3">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="includeOperatingCosts" style="width: auto; cursor: pointer;" />
          <span>Include Operating Costs</span>
        </label>
        <div class="muted">Insurance, maintenance, and registration</div>
      </div>
      <div class="col-4" id="insuranceField" style="display: none;">
        <label>Monthly Insurance ($)</label>
        <input id="insurance" type="number" inputmode="decimal" min="0" step="10" value="150" />
        <div class="muted">Average monthly insurance premium</div>
      </div>
      <div class="col-4" id="maintenanceField" style="display: none;">
        <label>Annual Maintenance & Repairs ($)</label>
        <input id="maintenance" type="number" inputmode="decimal" min="0" step="100" value="1200" />
        <div class="muted">Oil changes, tires, brakes, repairs (avg $100/month)</div>
      </div>
      <div class="col-4" id="registrationField" style="display: none;">
        <label>Annual Registration & Fees ($)</label>
        <input id="registration" type="number" inputmode="decimal" min="0" step="50" value="200" />
        <div class="muted">License plates, registration, inspection</div>
      </div>
    </div>
  </div>

  <div class="card">
    <button class="btn" id="calcBtn" aria-label="Calculate vehicle cost analysis">üîç Calculate Full Analysis</button>
  </div>

  <!-- TAB NAVIGATION -->
  <div id="tabNav" style="display:none; margin-bottom: 20px;" role="tablist" aria-label="Analysis sections">
    <div style="display: flex; gap: 12px; border-bottom: 2px solid #e2e8f0; padding-bottom: 0;">
      <button id="resultsTab" class="tab-btn active" role="tab" aria-selected="true" aria-controls="output" style="padding: 14px 24px; border: none; background: none; font-size: 15px; font-weight: 700; cursor: pointer; border-bottom: 3px solid #6495ED; color: #6495ED; font-family: 'Inter', sans-serif; transition: all 0.2s;">
        üìä Results
      </button>
      <button id="compareTab" class="tab-btn" role="tab" aria-selected="false" aria-controls="scenarioOutput" style="padding: 14px 24px; border: none; background: none; font-size: 15px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; color: #64748b; font-family: 'Inter', sans-serif; transition: all 0.2s;">
        üîÑ Compare Financing Routes
      </button>
      <button id="vehiclesTab" class="tab-btn" role="tab" aria-selected="false" aria-controls="vehiclesOutput" style="padding: 14px 24px; border: none; background: none; font-size: 15px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; color: #64748b; font-family: 'Inter', sans-serif; transition: all 0.2s;">
        ‚öñÔ∏è Compare Vehicles
      </button>
      <button id="leaseTab" class="tab-btn" role="tab" aria-selected="false" aria-controls="leaseOutput" style="padding: 14px 24px; border: none; background: none; font-size: 15px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; color: #64748b; font-family: 'Inter', sans-serif; transition: all 0.2s;">
        üí∞ Lease Calculator
      </button>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="output" style="display:none;" role="tabpanel" aria-labelledby="resultsTab">
    <!-- COST OF OWNERSHIP - PRIMARY EMPHASIS -->
    <div class="card hero-cost-card">
      <h2>üí∞ Total Cost of Ownership</h2>
      <div class="out">
        <div class="kpi col-4" id="netCostKpi">
          <h3>Net Cost of Ownership</h3>
          <div class="val" id="netCost">$‚Äî</div>
          <div class="sub" id="netCostSub">Total payments ‚àí equity recovered</div>
        </div>

        <div class="kpi col-4">
          <h3>True Monthly Cost</h3>
          <div class="val" id="monthlyCost">$‚Äî</div>
          <div class="sub" id="monthlyCostSub">True monthly cost to own this vehicle</div>
        </div>
        
        <div class="kpi col-4">
          <h3>Total Payments Made</h3>
          <div class="val" id="totalPmts">$‚Äî</div>
          <div class="sub" id="totalPmtsSub">‚Äî</div>
        </div>
        
        <div class="kpi col-4" id="equityRecoveredKpi">
          <h3>Net Proceeds at Exit</h3>
          <div class="val" id="equityRecovered">$‚Äî</div>
          <div class="sub" id="equityRecoveredSub">‚Äî</div>
        </div>
        
        <div class="kpi col-4" id="equity-breakdown">
          <h3>Equity Position</h3>
          <div class="val" id="equity">$‚Äî</div>
          <div class="sub" id="equitySub">Vehicle value ‚àí remaining balance</div>
        </div>
        
        <div class="kpi col-4" id="operatingCostsKpi" style="display: none;">
          <h3>Operating Costs</h3>
          <div class="val" id="operatingCosts">$‚Äî</div>
          <div class="sub">Insurance + maintenance + registration</div>
        </div>
      </div>
      
      <!-- Messages at bottom of Cost of Ownership section -->
      <div id="warn" class="warn" style="display:none; margin-top: 20px;"></div>
      <div id="info" class="info" style="display:none; margin-top: 20px;"></div>
      <div id="creditImpact" class="info" style="display:none; margin-top: 20px; background: linear-gradient(135deg, rgba(100, 149, 237, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%); border: 2px solid rgba(100, 149, 237, 0.4);"></div>
      <div id="leaseSuggestion" class="info" style="display:none; margin-top: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%); border: 2px solid rgba(16, 185, 129, 0.4); position: relative;"></div>
    </div>

    <!-- KEY METRICS -->
    <div class="card">
      <h2>Vehicle Valuation at Exit Point</h2>
      <div class="out">
        <div class="kpi col-4">
          <h3>Market Value (Avg)</h3>
          <div class="val" id="avgValue">$‚Äî</div>
          <div class="sub">Average of private & trade-in</div>
        </div>

        <div class="kpi col-4">
          <h3>Private Party Value</h3>
          <div class="val" id="privateValue">$‚Äî</div>
          <div class="sub" id="privateSub">‚Äî</div>
        </div>

        <div class="kpi col-4">
          <h3>Trade-In Value</h3>
          <div class="val" id="tradeValue">$‚Äî</div>
          <div class="sub" id="tradeSub">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- LOAN DETAILS -->
    <div class="card">
      <h2>Loan Analysis</h2>
      <div class="out">
        <div class="kpi col-3">
          <h3>Monthly Payment</h3>
          <div class="val" id="pmt">$‚Äî</div>
          <div class="sub">Base payment (P&I)</div>
        </div>

        <div class="kpi col-3">
          <h3>Remaining Balance</h3>
          <div class="val" id="balance">$‚Äî</div>
          <div class="sub" id="monthsElapsed">‚Äî</div>
        </div>

        <div class="kpi col-3">
          <h3>Total Interest Paid</h3>
          <div class="val" id="totalInterest">$‚Äî</div>
          <div class="sub">Through analysis point</div>
        </div>

        <div class="kpi col-3">
          <h3>Payoff Timeline</h3>
          <div class="val" id="payoffTime">‚Äî</div>
          <div class="sub" id="payoffSub">With extra payments</div>
        </div>
      </div>
    </div>

    <!-- DEPRECIATION INSIGHTS -->
    <div class="card">
      <h2>Depreciation Analysis</h2>
      <div class="out">
        <div class="kpi col-3">
          <h3>Residual Value %</h3>
          <div class="val" id="residualPct">‚Äî%</div>
          <div class="sub">Based on depreciation curve</div>
        </div>

        <div class="kpi col-3">
          <h3>Total Depreciation</h3>
          <div class="val" id="totalDepr">$‚Äî</div>
          <div class="sub">Original price to current value</div>
        </div>

        <div class="kpi col-3">
          <h3>Mileage Impact</h3>
          <div class="val" id="mileageImpact">‚Äî</div>
          <div class="sub" id="mileageSub">‚Äî</div>
        </div>

        <div class="kpi col-3">
          <h3>Annual Depreciation</h3>
          <div class="val" id="annualDepr">$‚Äî</div>
          <div class="sub">Average per year</div>
        </div>
      </div>
    </div>

    <!-- CHART -->
    <div class="card">
      <h2>Value vs Balance Over Time</h2>
      <div class="chart-container">
        <canvas id="equityChart"></canvas>
      </div>
    </div>

    <!-- DETAILED TABLE -->
    <div class="card">
      <h2>Detailed Breakdown</h2>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Value</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="detailsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- SCENARIO COMPARISON (Separate Tab) -->
  <div id="scenarioOutput" style="display:none;">
    <div class="card">
      <h2>üí° Compare Financing Routes</h2>
      <p style="color: #64748b; font-size: 14px; margin: 0 0 20px; line-height: 1.6;">
        Compare different financing strategies to find the best approach for your situation. Each route shows costs at your exit point and if held until loan payoff. Operating costs excluded for pure financing comparison.
      </p>
      <div class="scenario-grid" id="scenarioGrid"></div>
    </div>
  </div>

  <!-- VEHICLE COMPARISON (Separate Tab) -->
  <div id="vehiclesOutput" style="display:none;">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h2 style="margin: 0 0 8px;">‚öñÔ∏è Compare Vehicles</h2>
          <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.6;">
            Compare up to 3 vehicles side-by-side to find which one has the lowest cost of ownership.
          </p>
        </div>
        <div>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(100, 149, 237, 0.1); padding: 10px 16px; border-radius: 10px; border: 2px solid rgba(100, 149, 237, 0.3);">
            <input type="checkbox" id="syncFinancing" style="width: auto; cursor: pointer;" />
            <span style="color: #cbd5e1; font-size: 14px; font-weight: 600;">üîó Sync Financing</span>
          </label>
          <div style="color: #64748b; font-size: 11px; margin-top: 4px; text-align: right;">Same terms for all vehicles</div>
        </div>
      </div>
      
      <button class="btn" id="addVehicleBtn" style="margin-bottom: 24px;">
        ‚ûï Add Vehicle to Compare
      </button>
      
      <div id="vehicleComparisonGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px;"></div>
      
      <div id="noVehiclesMessage" style="text-align: center; padding: 60px 20px; color: #64748b;">
        <div style="font-size: 48px; margin-bottom: 16px;">üöó</div>
        <h3 style="color: #94a3b8; margin: 0 0 8px;">No Vehicles Added Yet</h3>
        <p style="margin: 0;">Click "Add Vehicle to Compare" to start comparing different vehicles.</p>
      </div>
    </div>
  </div>

  <!-- LEASE CALCULATOR (Separate Tab) -->
  <div id="leaseOutput" style="display:none;" role="tabpanel" aria-labelledby="leaseTab">
    <div class="card">
      <h2>üí∞ Lease Calculator</h2>
      <p style="color: #64748b; font-size: 14px; margin: 0 0 24px; line-height: 1.6;">
        Calculate your true lease costs including monthly payments, fees, and total cost over the lease term. Add to vehicle comparison to see how leasing stacks up against financing.
      </p>

      <!-- LEASE VEHICLE INFO -->
      <h3 style="color: #cbd5e1; font-size: 16px; margin: 24px 0 16px; font-weight: 700;">Vehicle Information</h3>
      <div class="grid">
        <div class="col-3">
          <label>Year</label>
          <select id="leaseYear">
            <option value="2027">2027</option>
            <option value="2026" selected>2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
          </select>
        </div>
        <div class="col-3">
          <label>Make</label>
          <select id="leaseMake">
            <option value="">Select Make...</option>
            <option value="Toyota">Toyota</option>
            <option value="Honda">Honda</option>
            <option value="Ford">Ford</option>
            <option value="Chevrolet">Chevrolet</option>
            <option value="BMW">BMW</option>
            <option value="Mercedes-Benz">Mercedes-Benz</option>
            <option value="Audi">Audi</option>
            <option value="Lexus">Lexus</option>
            <option value="Hyundai">Hyundai</option>
            <option value="Kia">Kia</option>
          </select>
        </div>
        <div class="col-3">
          <label>Model</label>
          <input id="leaseModel" type="text" placeholder="e.g., Accord, X5, RAV4" />
        </div>
        <div class="col-3">
          <label>Segment</label>
          <select id="leaseSegment">
            <option value="Generic">Generic / Sedan</option>
            <option value="SUV">SUV / Crossover</option>
            <option value="Truck">Truck</option>
            <option value="Luxury">Luxury</option>
            <option value="Sports">Sports / Performance</option>
            <option value="EV">Electric Vehicle</option>
            <option value="Hybrid">Hybrid</option>
          </select>
        </div>
      </div>

      <!-- LEASE PRICING -->
      <h3 style="color: #cbd5e1; font-size: 16px; margin: 24px 0 16px; font-weight: 700;">Lease Pricing</h3>
      <div class="grid">
        <div class="col-4">
          <label>MSRP (Sticker Price) ($)</label>
          <input id="leaseMSRP" type="number" inputmode="decimal" min="0" step="100" value="45000" />
          <div class="muted">Manufacturer suggested retail price</div>
        </div>
        <div class="col-4">
          <label>Agreed Upon Price ($)</label>
          <input id="leaseAgreedPrice" type="number" inputmode="decimal" min="0" step="100" value="42000" />
          <div class="muted">Negotiated selling price (capitalized cost)</div>
        </div>
        <div class="col-4">
          <label>Down Payment / Cap Reduction ($)</label>
          <input id="leaseDown" type="number" inputmode="decimal" min="0" step="100" value="3000" />
          <div class="muted">Upfront payment to reduce cap cost</div>
        </div>
      </div>

      <!-- LEASE TERMS -->
      <h3 style="color: #cbd5e1; font-size: 16px; margin: 24px 0 16px; font-weight: 700;">Lease Terms</h3>
      <div class="grid">
        <div class="col-3">
          <label>Lease Term (months)</label>
          <select id="leaseTerm">
            <option value="24">24 months (2 years)</option>
            <option value="36" selected>36 months (3 years)</option>
            <option value="39">39 months (3.25 years)</option>
            <option value="48">48 months (4 years)</option>
          </select>
        </div>
        <div class="col-3">
          <label>Residual Value (%)</label>
          <input id="leaseResidual" type="number" inputmode="decimal" min="0" max="100" step="1" value="55" />
          <div class="muted">What the car is worth at lease end (typically 50-60%)</div>
        </div>
        <div class="col-3">
          <label>Money Factor</label>
          <input id="leaseMoneyFactor" type="number" inputmode="decimal" min="0" max="1" step="0.00001" value="0.00125" />
          <div class="muted">Lease interest rate (0.00125 = ~3% APR)</div>
        </div>
        <div class="col-3">
          <label>Annual Mileage Allowance</label>
          <select id="leaseMileage">
            <option value="10000">10,000 miles/year</option>
            <option value="12000" selected>12,000 miles/year</option>
            <option value="15000">15,000 miles/year</option>
            <option value="18000">18,000 miles/year</option>
          </select>
        </div>
      </div>

      <!-- LEASE FEES & TAXES -->
      <h3 style="color: #cbd5e1; font-size: 16px; margin: 24px 0 16px; font-weight: 700;">Fees & Taxes</h3>
      <div class="grid">
        <div class="col-3">
          <label>Acquisition Fee ($)</label>
          <input id="leaseAcquisitionFee" type="number" inputmode="decimal" min="0" step="50" value="595" />
          <div class="muted">Bank/dealer fee to initiate lease (typically $395-$795)</div>
        </div>
        <div class="col-3">
          <label>Disposition Fee ($)</label>
          <input id="leaseDispositionFee" type="number" inputmode="decimal" min="0" step="50" value="395" />
          <div class="muted">Fee to return vehicle at lease end (typically $350-$500)</div>
        </div>
        <div class="col-3">
          <label>Sales Tax Rate (%)</label>
          <input id="leaseTaxRate" type="number" inputmode="decimal" min="0" max="15" step="0.1" value="8.25" />
          <div class="muted">Applied to monthly payment in most states</div>
        </div>
        <div class="col-3">
          <label>Registration & Fees ($)</label>
          <input id="leaseRegistration" type="number" inputmode="decimal" min="0" step="50" value="350" />
          <div class="muted">Upfront registration, plates, documentation</div>
        </div>
      </div>

      <!-- CALCULATE BUTTON -->
      <button class="btn" id="calcLeaseBtn" style="margin-top: 24px;" aria-label="Calculate lease analysis">
        üßÆ Calculate Lease
      </button>

      <!-- LEASE RESULTS -->
      <div id="leaseResults" style="display: none; margin-top: 32px;">
        <div class="card hero-cost-card">
          <h2>üìä Lease Cost Analysis</h2>
          <div class="out">
            <div class="kpi col-4" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%); border: 3px solid rgba(16, 185, 129, 0.6);">
              <h3 style="color: #d1fae5;">üí≥ MONTHLY PAYMENT (w/ Tax)</h3>
              <div class="val" id="leaseMonthlyPayment" style="color: #10b981; font-size: 42px;">$‚Äî</div>
              <div class="sub" style="color: #a7f3d0;">Your total monthly lease payment</div>
            </div>

            <div class="kpi col-4">
              <h3>Total Lease Cost</h3>
              <div class="val" id="leaseTotalCost">$‚Äî</div>
              <div class="sub">All payments + fees over lease term</div>
            </div>

            <div class="kpi col-4">
              <h3>Cost Per Month Owned</h3>
              <div class="val" id="leaseCostPerMonth">$‚Äî</div>
              <div class="sub">Total cost / months owned</div>
            </div>
          </div>

          <div class="out" style="margin-top: 12px;">
            <div class="kpi col-4">
              <h3>Base Monthly Payment</h3>
              <div class="val" id="leaseBasePayment">$‚Äî</div>
              <div class="sub">Before taxes</div>
            </div>

            <div class="kpi col-4">
              <h3>Total Depreciation</h3>
              <div class="val" id="leaseDepreciation">$‚Äî</div>
              <div class="sub">Vehicle value loss over lease</div>
            </div>

            <div class="kpi col-4">
              <h3>Total Interest Charges</h3>
              <div class="val" id="leaseInterest">$‚Äî</div>
              <div class="sub">Finance charges over lease term</div>
            </div>
          </div>

          <div class="out" style="margin-top: 12px;">
            <div class="kpi col-6">
              <h3>Due at Signing</h3>
              <div class="val" id="leaseDueAtSigning">$‚Äî</div>
              <div class="sub">Down payment + first month + fees + registration</div>
            </div>

            <div class="kpi col-6">
              <h3>Residual Value at End</h3>
              <div class="val" id="leaseResidualValue">$‚Äî</div>
              <div class="sub">What the car is worth when you return it</div>
            </div>
          </div>
        </div>

        <button class="btn-secondary" id="addLeaseToCompareBtn" style="margin-top: 20px;">
          ‚ûï Add This Lease to Vehicle Comparison
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
  // ================================
  // VEHICLE DATABASE (2026 MSRP Data - 30 brands, 146 models, 475 trims)
  // Data sourced from Edmunds.com on 2026-01-27
  const VEHICLE_DATABASE = {
    "Acura": {
      "Integra": [
        { trim: "A-Spec", msrp: 34000 },
        { trim: "A-Spec Tech", msrp: 37500 },
        { trim: "Type S", msrp: 51500 },
      ],
      "MDX": [
        { trim: "Base", msrp: 52900 },
        { trim: "A-Spec", msrp: 61150 },
        { trim: "Type S", msrp: 72050 },
      ],
      "RDX": [
        { trim: "Base", msrp: 45950 },
        { trim: "A-Spec", msrp: 51250 },
        { trim: "Advance", msrp: 53250 },
      ],
      "TLX": [
        { trim: "Base", msrp: 42200 },
        { trim: "A-Spec", msrp: 48200 },
        { trim: "Type S", msrp: 55700 },
      ],
    },
    "Audi": {
      "A4": [
        { trim: "Premium", msrp: 48100 },
        { trim: "Premium Plus", msrp: 51900 },
        { trim: "Prestige", msrp: 56100 },
      ],
      "A6": [
        { trim: "Premium", msrp: 59200 },
        { trim: "Premium Plus", msrp: 63000 },
      ],
      "Q5": [
        { trim: "Premium", msrp: 48200 },
        { trim: "Premium Plus", msrp: 52400 },
        { trim: "Prestige", msrp: 57900 },
      ],
      "Q7": [
        { trim: "Premium", msrp: 60900 },
        { trim: "Premium Plus", msrp: 66400 },
        { trim: "Prestige", msrp: 72700 },
      ],
      "Q8": [
        { trim: "Premium", msrp: 73900 },
        { trim: "Premium Plus", msrp: 79300 },
      ],
    },
    "BMW": {
      "3 Series": [
        { trim: "330i", msrp: 45900 },
        { trim: "330i xDrive", msrp: 48100 },
        { trim: "M340i xDrive", msrp: 60400 },
      ],
      "5 Series": [
        { trim: "530i", msrp: 58400 },
        { trim: "530i xDrive", msrp: 60700 },
        { trim: "i5 M60", msrp: 86800 },
      ],
      "M3": [
        { trim: "Competition xDrive", msrp: 81900 },
      ],
      "M4": [
        { trim: "Competition xDrive", msrp: 83900 },
      ],
      "X1": [
        { trim: "sDrive28i", msrp: 42300 },
        { trim: "xDrive28i", msrp: 44300 },
      ],
      "X3": [
        { trim: "sDrive30i", msrp: 49900 },
        { trim: "xDrive30i", msrp: 51900 },
        { trim: "M50", msrp: 66400 },
      ],
      "X5": [
        { trim: "xDrive40i", msrp: 66800 },
        { trim: "xDrive50e", msrp: 73400 },
        { trim: "M60i", msrp: 91800 },
      ],
    },
    "Buick": {
      "Enclave": [
        { trim: "Preferred", msrp: 49795 },
        { trim: "Sport Touring", msrp: 56395 },
        { trim: "Avenir", msrp: 62995 },
      ],
      "Encore GX": [
        { trim: "Preferred", msrp: 28495 },
        { trim: "Sport Touring", msrp: 32695 },
        { trim: "Avenir", msrp: 35695 },
      ],
      "Envision": [
        { trim: "Preferred", msrp: 37995 },
        { trim: "Avenir", msrp: 48895 },
      ],
      "Envista": [
        { trim: "Preferred", msrp: 25095 },
        { trim: "Avenir", msrp: 31995 },
      ],
    },
    "Cadillac": {
      "CT5": [
        { trim: "Luxury", msrp: 48590 },
        { trim: "V", msrp: 60590 },
        { trim: "V Blackwing", msrp: 93890 },
      ],
      "Escalade": [
        { trim: "Luxury", msrp: 83590 },
        { trim: "Premium Luxury", msrp: 91990 },
        { trim: "Sport", msrp: 96990 },
        { trim: "V", msrp: 155290 },
      ],
      "LYRIQ": [
        { trim: "Tech", msrp: 58590 },
        { trim: "Luxury", msrp: 61590 },
      ],
      "XT5": [
        { trim: "Luxury", msrp: 46790 },
        { trim: "Premium Luxury", msrp: 53490 },
        { trim: "Sport", msrp: 57690 },
      ],
      "XT6": [
        { trim: "Luxury", msrp: 52790 },
        { trim: "Premium Luxury", msrp: 59190 },
        { trim: "Sport", msrp: 63790 },
      ],
    },
    "Chevrolet": {
      "Colorado": [
        { trim: "WT", msrp: 30695 },
        { trim: "LT", msrp: 35995 },
        { trim: "Z71", msrp: 41495 },
        { trim: "ZR2", msrp: 52195 },
      ],
      "Corvette": [
        { trim: "Stingray 1LT", msrp: 68300 },
        { trim: "Stingray 3LT", msrp: 80700 },
        { trim: "Z06", msrp: 114395 },
      ],
      "Equinox": [
        { trim: "LT", msrp: 28600 },
        { trim: "RS", msrp: 33000 },
        { trim: "ACTIV", msrp: 33000 },
      ],
      "Silverado 1500": [
        { trim: "Work Truck", msrp: 44695 },
        { trim: "Custom", msrp: 47895 },
        { trim: "LT", msrp: 52495 },
        { trim: "RST", msrp: 53495 },
        { trim: "LTZ", msrp: 59695 },
        { trim: "High Country", msrp: 64695 },
        { trim: "ZR2", msrp: 71995 },
      ],
      "Tahoe": [
        { trim: "LS", msrp: 57195 },
        { trim: "LT", msrp: 62995 },
        { trim: "Z71", msrp: 68595 },
        { trim: "Premier", msrp: 73195 },
        { trim: "High Country", msrp: 80795 },
      ],
      "Traverse": [
        { trim: "LT", msrp: 40495 },
        { trim: "RS", msrp: 44295 },
        { trim: "Premier", msrp: 47995 },
        { trim: "High Country", msrp: 56995 },
      ],
      "Trax": [
        { trim: "LS", msrp: 21495 },
        { trim: "LT", msrp: 23795 },
        { trim: "Activ", msrp: 25795 },
      ],
    },
    "Chrysler": {
      "Pacifica": [
        { trim: "Touring", msrp: 41115 },
        { trim: "Touring L", msrp: 44330 },
        { trim: "Limited", msrp: 52960 },
        { trim: "Pinnacle", msrp: 59850 },
      ],
    },
    "Dodge": {
      "Charger": [
        { trim: "SXT", msrp: 37995 },
        { trim: "R/T", msrp: 45995 },
        { trim: "Scat Pack", msrp: 54995 },
      ],
      "Durango": [
        { trim: "SXT", msrp: 42795 },
        { trim: "GT", msrp: 47700 },
        { trim: "R/T", msrp: 58950 },
        { trim: "SRT 392", msrp: 72470 },
      ],
      "Hornet": [
        { trim: "GT", msrp: 34495 },
        { trim: "R/T", msrp: 39995 },
      ],
    },
    "Ford": {
      "Bronco": [
        { trim: "Base", msrp: 38720 },
        { trim: "Big Bend", msrp: 42720 },
        { trim: "Outer Banks", msrp: 46620 },
        { trim: "Badlands", msrp: 49715 },
        { trim: "Wildtrak", msrp: 55205 },
        { trim: "Raptor", msrp: 87995 },
      ],
      "Explorer": [
        { trim: "Active", msrp: 39995 },
        { trim: "ST-Line", msrp: 44640 },
        { trim: "ST", msrp: 54775 },
        { trim: "Platinum", msrp: 59740 },
      ],
      "F-150": [
        { trim: "XL", msrp: 46690 },
        { trim: "STX", msrp: 49945 },
        { trim: "XLT", msrp: 50650 },
        { trim: "Lariat", msrp: 62155 },
        { trim: "Tremor", msrp: 67510 },
        { trim: "Platinum", msrp: 73700 },
        { trim: "King Ranch", msrp: 73700 },
        { trim: "Raptor", msrp: 81600 },
      ],
      "Maverick": [
        { trim: "XL", msrp: 27470 },
        { trim: "XLT", msrp: 30055 },
        { trim: "Lariat", msrp: 35370 },
        { trim: "Tremor", msrp: 39560 },
      ],
      "Mustang": [
        { trim: "EcoBoost", msrp: 31920 },
        { trim: "EcoBoost Premium", msrp: 37770 },
        { trim: "GT", msrp: 43180 },
        { trim: "GT Premium", msrp: 48790 },
        { trim: "Dark Horse", msrp: 60775 },
      ],
      "Ranger": [
        { trim: "XL", msrp: 34960 },
        { trim: "XLT", msrp: 38040 },
        { trim: "Lariat", msrp: 46850 },
        { trim: "Raptor", msrp: 60080 },
      ],
    },
    "GMC": {
      "Acadia": [
        { trim: "SLE", msrp: 41695 },
        { trim: "SLT", msrp: 48695 },
        { trim: "Denali", msrp: 57495 },
      ],
      "Canyon": [
        { trim: "Elevation", msrp: 35000 },
        { trim: "AT4", msrp: 44500 },
        { trim: "Denali", msrp: 50000 },
      ],
      "Sierra 1500": [
        { trim: "Pro", msrp: 45500 },
        { trim: "SLE", msrp: 51500 },
        { trim: "SLT", msrp: 59400 },
        { trim: "AT4", msrp: 64100 },
        { trim: "Denali", msrp: 67200 },
        { trim: "AT4X", msrp: 77700 },
        { trim: "Denali Ultimate", msrp: 84300 },
      ],
      "Terrain": [
        { trim: "SLE", msrp: 32695 },
        { trim: "SLT", msrp: 37895 },
        { trim: "Denali", msrp: 43195 },
      ],
      "Yukon": [
        { trim: "SLE", msrp: 60200 },
        { trim: "SLT", msrp: 67600 },
        { trim: "AT4", msrp: 72500 },
        { trim: "Denali", msrp: 78600 },
        { trim: "Denali Ultimate", msrp: 95200 },
      ],
    },
    "Genesis": {
      "G70": [
        { trim: "2.0T", msrp: 44650 },
        { trim: "3.3T", msrp: 54800 },
      ],
      "G80": [
        { trim: "2.5T", msrp: 55200 },
        { trim: "3.5T Sport", msrp: 68700 },
      ],
      "GV70": [
        { trim: "2.5T", msrp: 47800 },
        { trim: "3.5T Sport", msrp: 61800 },
      ],
      "GV80": [
        { trim: "2.5T", msrp: 58200 },
        { trim: "3.5T Sport", msrp: 76200 },
      ],
    },
    "Honda": {
      "Accord": [
        { trim: "LX", msrp: 29490 },
        { trim: "EX-L", msrp: 35000 },
        { trim: "Sport Hybrid", msrp: 33740 },
        { trim: "Touring Hybrid", msrp: 41490 },
      ],
      "CR-V": [
        { trim: "LX", msrp: 30920 },
        { trim: "EX", msrp: 33250 },
        { trim: "Sport", msrp: 34250 },
        { trim: "EX-L", msrp: 36350 },
        { trim: "Sport Touring", msrp: 41050 },
      ],
      "Civic": [
        { trim: "LX", msrp: 25400 },
        { trim: "Sport", msrp: 27400 },
        { trim: "Sport Hybrid", msrp: 30100 },
        { trim: "Si", msrp: 31400 },
        { trim: "Sport Touring Hybrid", msrp: 33100 },
        { trim: "Type R", msrp: 44895 },
      ],
      "HR-V": [
        { trim: "LX", msrp: 26200 },
        { trim: "Sport", msrp: 28200 },
        { trim: "EX-L", msrp: 30700 },
      ],
      "Pilot": [
        { trim: "LX", msrp: 41025 },
        { trim: "EX-L", msrp: 46225 },
        { trim: "Touring", msrp: 52625 },
        { trim: "Elite", msrp: 56625 },
      ],
      "Ridgeline": [
        { trim: "Sport", msrp: 43445 },
        { trim: "RTL", msrp: 46755 },
        { trim: "TrailSport", msrp: 49755 },
      ],
    },
    "Hyundai": {
      "Elantra": [
        { trim: "SE", msrp: 23050 },
        { trim: "SEL", msrp: 24950 },
        { trim: "N", msrp: 35350 },
      ],
      "IONIQ 5": [
        { trim: "SE", msrp: 48650 },
        { trim: "SEL", msrp: 51450 },
        { trim: "Limited", msrp: 55850 },
        { trim: "N", msrp: 67500 },
      ],
      "Kona": [
        { trim: "SE", msrp: 27700 },
        { trim: "SEL", msrp: 30250 },
        { trim: "Limited", msrp: 34750 },
      ],
      "Palisade": [
        { trim: "SE", msrp: 40625 },
        { trim: "SEL", msrp: 43775 },
        { trim: "Limited", msrp: 50475 },
        { trim: "Calligraphy", msrp: 54175 },
      ],
      "Santa Fe": [
        { trim: "SE", msrp: 36150 },
        { trim: "SEL", msrp: 40050 },
        { trim: "Limited", msrp: 47250 },
        { trim: "Calligraphy", msrp: 51250 },
      ],
      "Sonata": [
        { trim: "SE", msrp: 29150 },
        { trim: "SEL", msrp: 31350 },
        { trim: "Limited", msrp: 37150 },
      ],
      "Tucson": [
        { trim: "SE", msrp: 31825 },
        { trim: "SEL", msrp: 34875 },
        { trim: "Limited", msrp: 40775 },
      ],
    },
    "Infiniti": {
      "Q50": [
        { trim: "Pure", msrp: 44650 },
        { trim: "Luxe", msrp: 48550 },
        { trim: "Red Sport 400", msrp: 61150 },
      ],
      "QX50": [
        { trim: "Pure", msrp: 43400 },
        { trim: "Luxe", msrp: 47650 },
        { trim: "Sensory", msrp: 53800 },
      ],
      "QX60": [
        { trim: "Pure", msrp: 52550 },
        { trim: "Luxe", msrp: 56150 },
        { trim: "Sensory", msrp: 62850 },
      ],
      "QX80": [
        { trim: "Pure", msrp: 77300 },
        { trim: "Luxe", msrp: 81900 },
        { trim: "Sensory", msrp: 92700 },
      ],
    },
    "Jeep": {
      "Compass": [
        { trim: "Sport", msrp: 32095 },
        { trim: "Latitude", msrp: 35195 },
        { trim: "Limited", msrp: 37495 },
        { trim: "Trailhawk", msrp: 39995 },
      ],
      "Gladiator": [
        { trim: "Sport", msrp: 42690 },
        { trim: "Sport S", msrp: 46790 },
        { trim: "Rubicon", msrp: 61990 },
      ],
      "Grand Cherokee": [
        { trim: "Laredo", msrp: 44290 },
        { trim: "Limited", msrp: 50385 },
        { trim: "Overland", msrp: 60285 },
        { trim: "Summit", msrp: 65285 },
      ],
      "Wrangler": [
        { trim: "Sport", msrp: 34995 },
        { trim: "Sport S", msrp: 39790 },
        { trim: "Sahara", msrp: 50380 },
        { trim: "Rubicon", msrp: 56480 },
        { trim: "392", msrp: 86755 },
      ],
    },
    "Kia": {
      "Carnival": [
        { trim: "LX", msrp: 35695 },
        { trim: "EX", msrp: 41990 },
        { trim: "SX Prestige", msrp: 49290 },
      ],
      "EV6": [
        { trim: "Light", msrp: 44750 },
        { trim: "Wind", msrp: 50750 },
        { trim: "GT", msrp: 62750 },
      ],
      "Forte": [
        { trim: "FE", msrp: 21690 },
        { trim: "LXS", msrp: 22690 },
        { trim: "GT", msrp: 26490 },
      ],
      "K5": [
        { trim: "LXS", msrp: 28190 },
        { trim: "GT-Line", msrp: 30490 },
        { trim: "GT", msrp: 35590 },
      ],
      "Sorento": [
        { trim: "LX", msrp: 35690 },
        { trim: "EX", msrp: 41690 },
        { trim: "SX", msrp: 46690 },
      ],
      "Sportage": [
        { trim: "LX", msrp: 31090 },
        { trim: "EX", msrp: 35090 },
        { trim: "SX", msrp: 39990 },
      ],
      "Telluride": [
        { trim: "LX", msrp: 38590 },
        { trim: "S", msrp: 41190 },
        { trim: "EX", msrp: 44990 },
        { trim: "SX", msrp: 49490 },
      ],
    },
    "Lexus": {
      "ES": [
        { trim: "ES 250", msrp: 43390 },
        { trim: "ES 350", msrp: 45740 },
        { trim: "ES 300h", msrp: 46340 },
      ],
      "GX": [
        { trim: "GX 550 Premium", msrp: 65800 },
        { trim: "GX 550 Luxury", msrp: 76600 },
      ],
      "IS": [
        { trim: "IS 300", msrp: 41635 },
        { trim: "IS 350", msrp: 46035 },
        { trim: "IS 500 F Sport", msrp: 59985 },
      ],
      "NX": [
        { trim: "NX 250", msrp: 42625 },
        { trim: "NX 350", msrp: 47125 },
        { trim: "NX 350h", msrp: 45975 },
      ],
      "RX": [
        { trim: "RX 350", msrp: 50920 },
        { trim: "RX 350h", msrp: 53520 },
        { trim: "RX 500h F Sport", msrp: 64770 },
      ],
      "TX": [
        { trim: "TX 350", msrp: 57750 },
        { trim: "TX 500h", msrp: 66900 },
      ],
    },
    "Lincoln": {
      "Aviator": [
        { trim: "Standard", msrp: 58000 },
        { trim: "Reserve", msrp: 67750 },
        { trim: "Black Label", msrp: 79995 },
      ],
      "Corsair": [
        { trim: "Standard", msrp: 41185 },
        { trim: "Reserve", msrp: 47985 },
      ],
      "Nautilus": [
        { trim: "Standard", msrp: 46985 },
        { trim: "Reserve", msrp: 55485 },
      ],
      "Navigator": [
        { trim: "Standard", msrp: 82650 },
        { trim: "Reserve", msrp: 89105 },
        { trim: "Black Label", msrp: 107500 },
      ],
    },
    "Mazda": {
      "CX-5": [
        { trim: "S Select", msrp: 29900 },
        { trim: "S Preferred", msrp: 32400 },
        { trim: "S Premium", msrp: 37100 },
        { trim: "Turbo", msrp: 40000 },
      ],
      "CX-50": [
        { trim: "S Select", msrp: 31600 },
        { trim: "S Premium", msrp: 39100 },
        { trim: "Turbo Premium Plus", msrp: 45500 },
      ],
      "CX-90": [
        { trim: "S Select", msrp: 42550 },
        { trim: "S Premium", msrp: 51000 },
        { trim: "Turbo Premium Plus", msrp: 59200 },
      ],
      "MX-5 Miata": [
        { trim: "Sport", msrp: 29490 },
        { trim: "Club", msrp: 33390 },
        { trim: "Grand Touring", msrp: 36590 },
      ],
      "Mazda3": [
        { trim: "2.5 S", msrp: 24970 },
        { trim: "2.5 Turbo", msrp: 34170 },
      ],
    },
    "Mercedes-Benz": {
      "C-Class": [
        { trim: "C 300", msrp: 48900 },
        { trim: "C 300 4MATIC", msrp: 50900 },
        { trim: "AMG C 43", msrp: 62850 },
      ],
      "E-Class": [
        { trim: "E 350", msrp: 59900 },
        { trim: "E 450 4MATIC", msrp: 66700 },
      ],
      "GLA": [
        { trim: "GLA 250", msrp: 42050 },
        { trim: "GLA 250 4MATIC", msrp: 44050 },
      ],
      "GLC": [
        { trim: "GLC 300", msrp: 49850 },
        { trim: "GLC 300 4MATIC", msrp: 51850 },
        { trim: "AMG GLC 43", msrp: 64450 },
      ],
      "GLE": [
        { trim: "GLE 350", msrp: 62250 },
        { trim: "GLE 450 4MATIC", msrp: 68850 },
        { trim: "AMG GLE 63 S", msrp: 119800 },
      ],
      "S-Class": [
        { trim: "S 500", msrp: 117800 },
        { trim: "S 580", msrp: 128300 },
      ],
    },
    "Mini": {
      "Cooper": [
        { trim: "Classic", msrp: 32900 },
        { trim: "S", msrp: 36900 },
        { trim: "John Cooper Works", msrp: 45900 },
      ],
      "Countryman": [
        { trim: "Classic", msrp: 37400 },
        { trim: "S", msrp: 41400 },
        { trim: "John Cooper Works", msrp: 54400 },
      ],
    },
    "Mitsubishi": {
      "Eclipse Cross": [
        { trim: "ES", msrp: 29195 },
        { trim: "SE", msrp: 31695 },
        { trim: "SEL", msrp: 33695 },
      ],
      "Outlander": [
        { trim: "ES", msrp: 32295 },
        { trim: "SE", msrp: 35495 },
        { trim: "SEL", msrp: 38995 },
      ],
      "Outlander Sport": [
        { trim: "ES", msrp: 29095 },
        { trim: "SE", msrp: 31195 },
      ],
    },
    "Nissan": {
      "Altima": [
        { trim: "S", msrp: 28440 },
        { trim: "SV", msrp: 30790 },
        { trim: "SL", msrp: 35340 },
        { trim: "Platinum", msrp: 37640 },
      ],
      "Frontier": [
        { trim: "S", msrp: 32340 },
        { trim: "SV", msrp: 38030 },
        { trim: "PRO-4X", msrp: 44490 },
      ],
      "Pathfinder": [
        { trim: "S", msrp: 38240 },
        { trim: "SV", msrp: 42440 },
        { trim: "SL", msrp: 48490 },
        { trim: "Platinum", msrp: 52340 },
      ],
      "Rogue": [
        { trim: "S", msrp: 31970 },
        { trim: "SV", msrp: 34570 },
        { trim: "SL", msrp: 41020 },
        { trim: "Platinum", msrp: 44020 },
      ],
      "Sentra": [
        { trim: "S", msrp: 22430 },
        { trim: "SV", msrp: 24430 },
        { trim: "SR", msrp: 26180 },
      ],
      "Z": [
        { trim: "Sport", msrp: 43990 },
        { trim: "Performance", msrp: 52990 },
        { trim: "NISMO", msrp: 67990 },
      ],
    },
    "Porsche": {
      "911": [
        { trim: "Carrera", msrp: 115100 },
        { trim: "Carrera S", msrp: 138800 },
        { trim: "Turbo S", msrp: 242200 },
      ],
      "Cayenne": [
        { trim: "Base", msrp: 79650 },
        { trim: "S", msrp: 95850 },
        { trim: "GTS", msrp: 116550 },
      ],
      "Macan": [
        { trim: "4", msrp: 75300 },
        { trim: "4S", msrp: 87700 },
        { trim: "Turbo", msrp: 106400 },
      ],
      "Taycan": [
        { trim: "Base", msrp: 92850 },
        { trim: "4S", msrp: 115850 },
        { trim: "Turbo S", msrp: 206850 },
      ],
    },
    "Ram": {
      "1500": [
        { trim: "Tradesman", msrp: 41350 },
        { trim: "Big Horn", msrp: 48085 },
        { trim: "Laramie", msrp: 56425 },
        { trim: "Rebel", msrp: 60445 },
        { trim: "Limited", msrp: 68475 },
        { trim: "Tungsten", msrp: 74480 },
      ],
    },
    "Subaru": {
      "Ascent": [
        { trim: "Base", msrp: 37795 },
        { trim: "Premium", msrp: 41095 },
        { trim: "Limited", msrp: 45695 },
        { trim: "Touring", msrp: 49295 },
      ],
      "Crosstrek": [
        { trim: "Base", msrp: 29695 },
        { trim: "Premium", msrp: 31195 },
        { trim: "Limited", msrp: 35195 },
        { trim: "Wilderness", msrp: 35995 },
      ],
      "Forester": [
        { trim: "Base", msrp: 34095 },
        { trim: "Premium", msrp: 37195 },
        { trim: "Limited", msrp: 40395 },
        { trim: "Touring", msrp: 42495 },
        { trim: "Wilderness", msrp: 40895 },
      ],
      "Outback": [
        { trim: "Base", msrp: 32395 },
        { trim: "Premium", msrp: 35495 },
        { trim: "Limited", msrp: 40595 },
        { trim: "Touring", msrp: 43395 },
        { trim: "Wilderness", msrp: 42995 },
      ],
      "WRX": [
        { trim: "Base", msrp: 32985 },
        { trim: "Premium", msrp: 36285 },
        { trim: "Limited", msrp: 40285 },
      ],
    },
    "Tesla": {
      "Cybertruck": [
        { trim: "Rear-Wheel Drive", msrp: 60990 },
        { trim: "All-Wheel Drive", msrp: 79990 },
        { trim: "Cyberbeast", msrp: 99990 },
      ],
      "Model 3": [
        { trim: "Rear-Wheel Drive", msrp: 42490 },
        { trim: "Long Range", msrp: 49490 },
        { trim: "Performance", msrp: 54490 },
      ],
      "Model S": [
        { trim: "Dual Motor", msrp: 79990 },
        { trim: "Plaid", msrp: 94990 },
      ],
      "Model X": [
        { trim: "Dual Motor", msrp: 84990 },
        { trim: "Plaid", msrp: 99990 },
      ],
      "Model Y": [
        { trim: "Rear-Wheel Drive", msrp: 44990 },
        { trim: "Long Range", msrp: 49990 },
        { trim: "Performance", msrp: 54490 },
      ],
    },
    "Toyota": {
      "4Runner": [
        { trim: "SR5", msrp: 42220 },
        { trim: "TRD Off-Road", msrp: 50875 },
        { trim: "Limited", msrp: 55225 },
        { trim: "TRD Pro", msrp: 66610 },
        { trim: "Trailhunter", msrp: 67400 },
      ],
      "Camry": [
        { trim: "LE", msrp: 29895 },
        { trim: "SE", msrp: 32195 },
        { trim: "XLE", msrp: 34895 },
        { trim: "XSE", msrp: 36095 },
      ],
      "Corolla": [
        { trim: "LE", msrp: 22325 },
        { trim: "SE", msrp: 24500 },
        { trim: "XSE", msrp: 27750 },
      ],
      "Highlander": [
        { trim: "LE", msrp: 40320 },
        { trim: "XLE", msrp: 44285 },
        { trim: "Limited", msrp: 50275 },
        { trim: "Platinum", msrp: 53025 },
      ],
      "Land Cruiser": [
        { trim: "1958", msrp: 58195 },
        { trim: "Base", msrp: 62965 },
      ],
      "Prius": [
        { trim: "LE", msrp: 28545 },
        { trim: "XLE", msrp: 31380 },
        { trim: "Limited", msrp: 36165 },
      ],
      "RAV4": [
        { trim: "LE", msrp: 29800 },
        { trim: "XLE", msrp: 31790 },
        { trim: "XLE Premium", msrp: 35275 },
        { trim: "Adventure", msrp: 36470 },
        { trim: "Limited", msrp: 39895 },
      ],
      "Tacoma": [
        { trim: "SR", msrp: 31490 },
        { trim: "SR5", msrp: 35875 },
        { trim: "TRD Sport", msrp: 41695 },
        { trim: "Limited", msrp: 49065 },
        { trim: "TRD Pro", msrp: 61835 },
      ],
      "Tundra": [
        { trim: "SR", msrp: 41000 },
        { trim: "SR5", msrp: 45225 },
        { trim: "Limited", msrp: 56825 },
        { trim: "Platinum", msrp: 64625 },
      ],
    },
    "Volkswagen": {
      "Atlas": [
        { trim: "SE", msrp: 42375 },
        { trim: "SEL", msrp: 50275 },
        { trim: "SEL Premium", msrp: 56545 },
      ],
      "Golf GTI": [
        { trim: "S", msrp: 32685 },
        { trim: "SE", msrp: 36685 },
      ],
      "Golf R": [
        { trim: "Base", msrp: 46585 },
      ],
      "Jetta": [
        { trim: "S", msrp: 23245 },
        { trim: "SE", msrp: 25845 },
        { trim: "SEL", msrp: 30795 },
      ],
      "Taos": [
        { trim: "S", msrp: 25495 },
        { trim: "SE", msrp: 29015 },
        { trim: "SEL", msrp: 33875 },
      ],
      "Tiguan": [
        { trim: "S", msrp: 30995 },
        { trim: "SE", msrp: 35725 },
        { trim: "SEL", msrp: 42315 },
      ],
    },
    "Volvo": {
      "EX30": [
        { trim: "Core", msrp: 36245 },
        { trim: "Plus", msrp: 40495 },
        { trim: "Ultra", msrp: 46795 },
      ],
      "S60": [
        { trim: "Core", msrp: 44150 },
        { trim: "Plus", msrp: 48550 },
      ],
      "XC40": [
        { trim: "Core", msrp: 39490 },
        { trim: "Plus", msrp: 43490 },
      ],
      "XC60": [
        { trim: "Core", msrp: 47450 },
        { trim: "Plus", msrp: 52900 },
        { trim: "Ultimate", msrp: 59800 },
      ],
      "XC90": [
        { trim: "Core", msrp: 58900 },
        { trim: "Plus", msrp: 64250 },
        { trim: "Ultimate", msrp: 76200 },
      ],
    },
  };
  // Year-based depreciation multipliers for estimating older model prices
  // Market premium range for used vehicles (dealer markup, condition, etc.)
  const MARKET_PREMIUM = {
    min: 1.05,  // 5% over depreciated value (good deal)
    avg: 1.07,  // 7% over depreciated value (typical)
    max: 1.10   // 10% over depreciated value (dealer premium)
  };

  // Calculate realistic purchase price based on year and vehicle characteristics
  function calculateSuggestedPrice(year, make, model, trimMsrp) {
    const currentYear = 2026;
    const age = currentYear - year;
    
    // New vehicles (current year): Use MSRP
    if (age === 0) {
      return trimMsrp;
    }
    
    // Future year (2027): Add premium for next model year
    if (age < 0) {
      return Math.round(trimMsrp * 1.03); // 3% premium
    }
    
    // Used vehicles: Use depreciation model + market premium
    const segment = getModelSegment(make, model);
    const segmentCurve = getSegmentCurve(segment);
    const brandMod = getBrandModifier(make);
    const modelMod = getModelOverride(make, model);
    const combinedMod = brandMod * modelMod;
    
    // Get residual value at this age
    let residual;
    if (age < segmentCurve.length) {
      residual = segmentCurve[age] * combinedMod;
      residual = clamp(residual, 0.10, 1.00);
    } else {
      // Older than curve data, use last value with continued decay
      residual = segmentCurve[segmentCurve.length - 1] * combinedMod;
      const yearsOver = age - (segmentCurve.length - 1);
      residual = residual * Math.pow(0.92, yearsOver); // 8% annual decay
      residual = clamp(residual, 0.05, 1.00);
    }
    
    // Base depreciated value
    const depreciatedValue = trimMsrp * residual;
    
    // Add market premium (use average 7%)
    const marketPrice = depreciatedValue * MARKET_PREMIUM.avg;
    
    return Math.round(marketPrice);
  }

  // ================================
  // DEPRECIATION CURVES
  // ================================
  // ================================
  // ENHANCED DEPRECIATION MODEL
  // 15 segment-specific curves + brand modifiers + model overrides
  // ================================
  
  // Segment-specific depreciation curves (0-15 years)
  const SEGMENT_CURVES = {
    "TRUCK_FULLSIZE": [1.00, 0.85, 0.76, 0.69, 0.63, 0.58, 0.53, 0.48, 0.44, 0.41, 0.38, 0.35, 0.32, 0.30, 0.28, 0.26],
    "TRUCK_MIDSIZE": [1.00, 0.83, 0.74, 0.67, 0.61, 0.56, 0.51, 0.46, 0.42, 0.39, 0.36, 0.33, 0.30, 0.28, 0.26, 0.24],
    "SUV_FULLSIZE": [1.00, 0.82, 0.73, 0.66, 0.60, 0.55, 0.50, 0.46, 0.42, 0.39, 0.36, 0.33, 0.30, 0.28, 0.26, 0.24],
    "SUV_MIDSIZE": [1.00, 0.80, 0.71, 0.64, 0.58, 0.53, 0.48, 0.44, 0.40, 0.37, 0.34, 0.31, 0.28, 0.26, 0.24, 0.22],
    "SUV_COMPACT": [1.00, 0.78, 0.68, 0.61, 0.55, 0.50, 0.45, 0.41, 0.37, 0.34, 0.31, 0.28, 0.26, 0.24, 0.22, 0.20],
    "SEDAN_LUXURY": [1.00, 0.72, 0.60, 0.51, 0.44, 0.38, 0.33, 0.29, 0.25, 0.22, 0.20, 0.18, 0.16, 0.14, 0.13, 0.12],
    "SEDAN_MIDSIZE": [1.00, 0.76, 0.65, 0.57, 0.50, 0.44, 0.39, 0.35, 0.31, 0.28, 0.25, 0.23, 0.21, 0.19, 0.17, 0.16],
    "SEDAN_COMPACT": [1.00, 0.75, 0.64, 0.56, 0.49, 0.43, 0.38, 0.34, 0.30, 0.27, 0.24, 0.22, 0.20, 0.18, 0.16, 0.15],
    "SEDAN_SUBCOMPACT": [1.00, 0.73, 0.62, 0.54, 0.47, 0.41, 0.36, 0.32, 0.28, 0.25, 0.22, 0.20, 0.18, 0.16, 0.15, 0.14],
    "SPORTS_CAR": [1.00, 0.78, 0.68, 0.60, 0.54, 0.48, 0.43, 0.39, 0.35, 0.32, 0.29, 0.27, 0.25, 0.23, 0.21, 0.20],
    "SPORTS_EXOTIC": [1.00, 0.82, 0.75, 0.70, 0.66, 0.63, 0.60, 0.58, 0.56, 0.55, 0.54, 0.53, 0.52, 0.52, 0.53, 0.55],
    "MINIVAN": [1.00, 0.74, 0.63, 0.55, 0.48, 0.42, 0.37, 0.33, 0.29, 0.26, 0.23, 0.21, 0.19, 0.17, 0.15, 0.14],
    "EV_MAINSTREAM": [1.00, 0.68, 0.55, 0.46, 0.39, 0.34, 0.30, 0.27, 0.24, 0.22, 0.20, 0.18, 0.16, 0.15, 0.14, 0.13],
    "EV_PREMIUM": [1.00, 0.65, 0.52, 0.43, 0.37, 0.32, 0.28, 0.25, 0.22, 0.20, 0.18, 0.16, 0.15, 0.14, 0.13, 0.12],
    "HYBRID": [1.00, 0.79, 0.70, 0.63, 0.57, 0.52, 0.47, 0.43, 0.39, 0.36, 0.33, 0.30, 0.28, 0.26, 0.24, 0.22]
  };

  // Brand retention modifiers (applied as multiplier to segment curve)
  const BRAND_MODIFIERS = {
    "Toyota": 1.08, "Lexus": 1.06, "Honda": 1.05, "Acura": 1.02, "Subaru": 1.04, "Mazda": 1.02,
    "Nissan": 0.98, "Infiniti": 0.96, "Mitsubishi": 0.95, "Hyundai": 1.00, "Kia": 1.00,
    "Genesis": 1.01, "Ford": 1.01, "Chevrolet": 1.00, "GMC": 1.03, "Ram": 1.02, "Jeep": 1.04,
    "Dodge": 0.98, "Chrysler": 0.95, "Buick": 0.97, "Cadillac": 0.96, "Lincoln": 0.96,
    "BMW": 0.95, "Mercedes-Benz": 0.96, "Audi": 0.96, "Volkswagen": 0.98, "Porsche": 1.06,
    "Mini": 0.97, "Volvo": 0.98, "Tesla": 1.02
  };

  // Model-to-segment mapping (auto-populates segment based on make/model)
  const MODEL_SEGMENTS = {
    // Acura
    "Acura|Integra": "SEDAN_COMPACT", "Acura|MDX": "SUV_MIDSIZE", "Acura|RDX": "SUV_COMPACT", "Acura|TLX": "SEDAN_MIDSIZE",
    // Audi
    "Audi|A4": "SEDAN_LUXURY", "Audi|A6": "SEDAN_LUXURY", "Audi|Q5": "SUV_COMPACT", "Audi|Q7": "SUV_FULLSIZE", "Audi|Q8": "SUV_FULLSIZE",
    // BMW
    "BMW|3 Series": "SEDAN_LUXURY", "BMW|5 Series": "SEDAN_LUXURY", "BMW|X3": "SUV_COMPACT", "BMW|X5": "SUV_MIDSIZE", "BMW|X7": "SUV_FULLSIZE",
    // Buick
    "Buick|Encore": "SUV_COMPACT", "Buick|Envision": "SUV_COMPACT",
    // Cadillac
    "Cadillac|CT5": "SEDAN_LUXURY", "Cadillac|Escalade": "SUV_FULLSIZE", "Cadillac|XT4": "SUV_COMPACT", "Cadillac|XT5": "SUV_MIDSIZE", "Cadillac|XT6": "SUV_FULLSIZE",
    // Chevrolet
    "Chevrolet|Blazer": "SUV_MIDSIZE", "Chevrolet|Colorado": "TRUCK_MIDSIZE", "Chevrolet|Corvette": "SPORTS_CAR", "Chevrolet|Equinox": "SUV_COMPACT",
    "Chevrolet|Malibu": "SEDAN_MIDSIZE", "Chevrolet|Silverado 1500": "TRUCK_FULLSIZE", "Chevrolet|Tahoe": "SUV_FULLSIZE", "Chevrolet|Trailblazer": "SUV_COMPACT", "Chevrolet|Traverse": "SUV_MIDSIZE",
    // Chrysler
    "Chrysler|Pacifica": "MINIVAN",
    // Dodge
    "Dodge|Challenger": "SPORTS_CAR", "Dodge|Charger": "SEDAN_MIDSIZE", "Dodge|Durango": "SUV_MIDSIZE",
    // Ford
    "Ford|Bronco": "SUV_MIDSIZE", "Ford|Bronco Sport": "SUV_COMPACT", "Ford|Edge": "SUV_MIDSIZE", "Ford|Escape": "SUV_COMPACT", "Ford|Explorer": "SUV_MIDSIZE",
    "Ford|F-150": "TRUCK_FULLSIZE", "Ford|F-150 Lightning": "TRUCK_FULLSIZE", "Ford|Maverick": "TRUCK_MIDSIZE", "Ford|Mustang": "SPORTS_CAR", "Ford|Mustang Mach-E": "EV_MAINSTREAM", "Ford|Ranger": "TRUCK_MIDSIZE",
    // Genesis
    "Genesis|G70": "SEDAN_LUXURY", "Genesis|G80": "SEDAN_LUXURY", "Genesis|GV70": "SUV_COMPACT", "Genesis|GV80": "SUV_MIDSIZE",
    // GMC
    "GMC|Acadia": "SUV_MIDSIZE", "GMC|Canyon": "TRUCK_MIDSIZE", "GMC|Sierra 1500": "TRUCK_FULLSIZE", "GMC|Terrain": "SUV_COMPACT", "GMC|Yukon": "SUV_FULLSIZE",
    // Honda
    "Honda|Accord": "SEDAN_MIDSIZE", "Honda|Civic": "SEDAN_COMPACT", "Honda|CR-V": "SUV_COMPACT", "Honda|Odyssey": "MINIVAN", "Honda|Passport": "SUV_MIDSIZE", "Honda|Pilot": "SUV_MIDSIZE", "Honda|Ridgeline": "TRUCK_MIDSIZE",
    // Hyundai
    "Hyundai|Elantra": "SEDAN_COMPACT", "Hyundai|IONIQ 5": "EV_MAINSTREAM", "Hyundai|Kona": "SUV_COMPACT", "Hyundai|Palisade": "SUV_MIDSIZE",
    "Hyundai|Santa Fe": "SUV_MIDSIZE", "Hyundai|Sonata": "SEDAN_MIDSIZE", "Hyundai|Tucson": "SUV_COMPACT",
    // Infiniti
    "Infiniti|Q50": "SEDAN_LUXURY", "Infiniti|QX50": "SUV_COMPACT", "Infiniti|QX60": "SUV_MIDSIZE", "Infiniti|QX80": "SUV_FULLSIZE",
    // Jeep
    "Jeep|Cherokee": "SUV_COMPACT", "Jeep|Compass": "SUV_COMPACT", "Jeep|Gladiator": "TRUCK_MIDSIZE", "Jeep|Grand Cherokee": "SUV_MIDSIZE", "Jeep|Grand Wagoneer": "SUV_FULLSIZE", "Jeep|Wrangler": "SUV_COMPACT",
    // Kia
    "Kia|Carnival": "MINIVAN", "Kia|EV6": "EV_MAINSTREAM", "Kia|Forte": "SEDAN_COMPACT", "Kia|K5": "SEDAN_MIDSIZE", "Kia|Niro": "HYBRID",
    "Kia|Seltos": "SUV_COMPACT", "Kia|Sorento": "SUV_MIDSIZE", "Kia|Sportage": "SUV_COMPACT", "Kia|Telluride": "SUV_MIDSIZE",
    // Lexus
    "Lexus|ES": "SEDAN_LUXURY", "Lexus|GX": "SUV_MIDSIZE", "Lexus|IS": "SEDAN_LUXURY", "Lexus|NX": "SUV_COMPACT", "Lexus|RX": "SUV_MIDSIZE", "Lexus|TX": "SUV_MIDSIZE",
    // Lincoln
    "Lincoln|Aviator": "SUV_MIDSIZE", "Lincoln|Corsair": "SUV_COMPACT", "Lincoln|Nautilus": "SUV_MIDSIZE", "Lincoln|Navigator": "SUV_FULLSIZE",
    // Mazda
    "Mazda|CX-5": "SUV_COMPACT", "Mazda|CX-50": "SUV_COMPACT", "Mazda|CX-70": "SUV_MIDSIZE", "Mazda|CX-90": "SUV_MIDSIZE", "Mazda|Mazda3": "SEDAN_COMPACT", "Mazda|MX-5": "SPORTS_CAR",
    // Mercedes-Benz
    "Mercedes-Benz|C-Class": "SEDAN_LUXURY", "Mercedes-Benz|E-Class": "SEDAN_LUXURY", "Mercedes-Benz|GLC": "SUV_COMPACT", "Mercedes-Benz|GLE": "SUV_MIDSIZE", "Mercedes-Benz|GLS": "SUV_FULLSIZE",
    // Mini
    "Mini|Cooper": "SEDAN_SUBCOMPACT", "Mini|Countryman": "SUV_COMPACT",
    // Mitsubishi
    "Mitsubishi|Eclipse Cross": "SUV_COMPACT", "Mitsubishi|Outlander": "SUV_COMPACT",
    // Nissan
    "Nissan|Altima": "SEDAN_MIDSIZE", "Nissan|Armada": "SUV_FULLSIZE", "Nissan|Ariya": "EV_MAINSTREAM", "Nissan|Frontier": "TRUCK_MIDSIZE",
    "Nissan|Kicks": "SUV_COMPACT", "Nissan|Leaf": "EV_MAINSTREAM", "Nissan|Murano": "SUV_MIDSIZE", "Nissan|Pathfinder": "SUV_MIDSIZE",
    "Nissan|Rogue": "SUV_COMPACT", "Nissan|Sentra": "SEDAN_COMPACT", "Nissan|Versa": "SEDAN_SUBCOMPACT", "Nissan|Z": "SPORTS_CAR",
    // Porsche
    "Porsche|911": "SPORTS_EXOTIC", "Porsche|Cayenne": "SUV_MIDSIZE", "Porsche|Macan": "SUV_COMPACT", "Porsche|Taycan": "EV_PREMIUM",
    // Ram
    "Ram|1500": "TRUCK_FULLSIZE",
    // Subaru
    "Subaru|Ascent": "SUV_MIDSIZE", "Subaru|Crosstrek": "SUV_COMPACT", "Subaru|Forester": "SUV_COMPACT", "Subaru|Impreza": "SEDAN_COMPACT",
    "Subaru|Legacy": "SEDAN_MIDSIZE", "Subaru|Outback": "SUV_COMPACT", "Subaru|WRX": "SPORTS_CAR",
    // Tesla
    "Tesla|Model 3": "EV_MAINSTREAM", "Tesla|Model S": "EV_PREMIUM", "Tesla|Model X": "EV_PREMIUM", "Tesla|Model Y": "EV_MAINSTREAM",
    // Toyota
    "Toyota|4Runner": "SUV_MIDSIZE", "Toyota|Camry": "SEDAN_MIDSIZE", "Toyota|Corolla": "SEDAN_COMPACT", "Toyota|Highlander": "SUV_MIDSIZE",
    "Toyota|Land Cruiser": "SUV_FULLSIZE", "Toyota|Prius": "HYBRID", "Toyota|RAV4": "SUV_COMPACT", "Toyota|Tacoma": "TRUCK_MIDSIZE", "Toyota|Tundra": "TRUCK_FULLSIZE",
    // Volkswagen
    "Volkswagen|Atlas": "SUV_MIDSIZE", "Volkswagen|Golf GTI": "SEDAN_COMPACT", "Volkswagen|Golf R": "SPORTS_CAR", "Volkswagen|Jetta": "SEDAN_COMPACT",
    "Volkswagen|Taos": "SUV_COMPACT", "Volkswagen|Tiguan": "SUV_COMPACT",
    // Volvo
    "Volvo|EX30": "EV_MAINSTREAM", "Volvo|S60": "SEDAN_LUXURY", "Volvo|XC40": "SUV_COMPACT", "Volvo|XC60": "SUV_COMPACT", "Volvo|XC90": "SUV_MIDSIZE"
  };

  // Get segment for a make/model combination
  function getModelSegment(make, model) {
    const key = `${make}|${model}`;
    return MODEL_SEGMENTS[key] || "SEDAN_MIDSIZE"; // Default fallback
  }

  // Model-specific overrides (exceptional performers/laggards)
  const MODEL_OVERRIDES = {
    "Toyota|Tacoma": 1.12,
    "Toyota|4Runner": 1.15,
    "Toyota|Land Cruiser": 1.20,
    "Toyota|Tundra": 1.06,
    "Honda|Civic": 1.05,
    "Jeep|Wrangler": 1.18,
    "Jeep|Gladiator": 1.10,
    "Porsche|911": 1.10,
    "Ford|Bronco": 1.08,
    "Ford|Maverick": 1.06,
    "Chevrolet|Corvette": 1.12,
    "Subaru|WRX": 1.06,
    "Tesla|Model Y": 1.08,
    "Tesla|Model 3": 1.05,
    "Hyundai|Palisade": 1.06,
    "Kia|Telluride": 1.08,
    "BMW|3 Series": 0.95,
    "Mercedes-Benz|EQS": 0.88,
    "Nissan|Leaf": 0.85,
    "Lexus|GX": 1.12,
    "Mazda|MX-5": 1.08,
    "Cadillac|Escalade": 1.06,
    "Dodge|Challenger": 1.08,
    "Dodge|Charger": 1.04,
    "Ford|F-150 Lightning": 0.92
  };

  // Segment-specific mileage impact (% change per 1,000 miles deviation)
  const MILEAGE_COEFFICIENTS = {
    "TRUCK_FULLSIZE": -0.35, "TRUCK_MIDSIZE": -0.40, "SUV_FULLSIZE": -0.38, "SUV_MIDSIZE": -0.42,
    "SUV_COMPACT": -0.45, "SEDAN_LUXURY": -0.55, "SEDAN_MIDSIZE": -0.48, "SEDAN_COMPACT": -0.50,
    "SEDAN_SUBCOMPACT": -0.52, "SPORTS_CAR": -0.60, "SPORTS_EXOTIC": -0.70, "MINIVAN": -0.45,
    "EV_MAINSTREAM": -0.30, "EV_PREMIUM": -0.35, "HYBRID": -0.38
  };

  // Map old segment names to new granular segments
  const SEGMENT_MAPPING = {
    "EV": "EV_MAINSTREAM",
    "TRUCK": "TRUCK_FULLSIZE", 
    "SUV": "SUV_MIDSIZE",
    "HYBRID": "HYBRID",
    "SPORTS": "SPORTS_CAR"
  };

  // Get the appropriate curve for a segment
  function getSegmentCurve(segment) {
    // Map old segment names to new ones
    const mappedSegment = SEGMENT_MAPPING[segment] || segment;
    return SEGMENT_CURVES[mappedSegment] || SEGMENT_CURVES["SEDAN_MIDSIZE"]; // Default to mid-size sedan
  }

  // Get brand modifier
  function getBrandModifier(make) {
    return BRAND_MODIFIERS[make] || 1.00;
  }

  // Get model-specific override
  function getModelOverride(make, model) {
    const key = `${make}|${model}`;
    return MODEL_OVERRIDES[key] || 1.00;
  }

  // Get mileage coefficient for segment
  function getMileageCoefficient(segment) {
    const mappedSegment = SEGMENT_MAPPING[segment] || segment;
    return MILEAGE_COEFFICIENTS[mappedSegment] || -0.45;
  }

  // ================================
  // UTILITY FUNCTIONS
  // ================================
  function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }
  function fmtMoney(x) {
    if (!isFinite(x)) return "$‚Äî";
    return x.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
  }
  function fmtPct(x) { return `${x.toFixed(1)}%`; }
  function readNumber(id) { 
    const val = document.getElementById(id).value;
    return Number(val);
  }
  function readText(id) { 
    return String(document.getElementById(id).value || "").trim();
  }

  function interpolateResidual(years, curve) {
    if (years <= 0) return curve[0];
    const y0 = Math.floor(years);
    const y1 = Math.ceil(years);
    if (y0 === y1) return curve[y0] ?? curve[Math.max(...Object.keys(curve).map(Number))];
    const r0 = curve[y0] ?? curve[Math.max(...Object.keys(curve).map(Number))];
    const r1 = curve[y1] ?? curve[Math.max(...Object.keys(curve).map(Number))];
    const t = (years - y0) / (y1 - y0);
    return r0 + t * (r1 - r0);
  }

  // Build enhanced depreciation curve with brand/model modifiers
  function buildDepreciationCurve(maxYear, post5AnnualPct, segment, make, model) {
    // Step 1: Get base segment curve
    const segmentCurve = getSegmentCurve(segment);
    
    // Step 2: Apply brand modifier
    const brandMod = getBrandModifier(make);
    
    // Step 3: Apply model-specific override
    const modelMod = getModelOverride(make, model);
    
    // Step 4: Combine modifiers
    const combinedModifier = brandMod * modelMod;
    
    // Step 5: Build curve up to year 15 (or maxYear if less)
    const curve = {};
    const curveLimit = Math.min(15, maxYear);
    
    for (let y = 0; y <= curveLimit; y++) {
      if (y < segmentCurve.length) {
        // Apply combined modifier, but clamp to reasonable bounds
        curve[y] = clamp(segmentCurve[y] * combinedModifier, 0.10, 1.00);
      }
    }
    
    // Step 6: Extend beyond year 15 (or segment curve length) with post-5 decay
    if (maxYear > curveLimit) {
      const decay = post5AnnualPct / 100;
      let last = curve[curveLimit];
      
      for (let y = curveLimit + 1; y <= maxYear; y++) {
        last = last * (1 - decay);
        curve[y] = clamp(last, 0.05, 1.00);
      }
    }
    
    return curve;
  }

  // ================================
  // LOAN FUNCTIONS
  // ================================
  function monthlyPayment(principal, aprPct, termMonths) {
    const r = (aprPct / 100) / 12;
    if (termMonths <= 0) throw new Error("Loan term must be > 0");
    if (r === 0) return principal / termMonths;
    const pow = Math.pow(1 + r, termMonths);
    return principal * (r * pow) / (pow - 1);
  }

  function remainingBalance(principal, aprPct, termMonths, monthsElapsed, extraMonthly = 0) {
    const m = clamp(monthsElapsed, 0, termMonths);
    const r = (aprPct / 100) / 12;
    const basePmt = monthlyPayment(principal, aprPct, termMonths);
    const totalPmt = basePmt + extraMonthly;
    
    let bal = principal;
    for (let i = 0; i < m; i++) {
      const interest = bal * r;
      const principalPmt = totalPmt - interest;
      bal -= principalPmt;
      if (bal <= 0) return 0;
    }
    return Math.max(0, bal);
  }

  function totalInterestPaid(principal, aprPct, termMonths, monthsElapsed, extraMonthly = 0) {
    const r = (aprPct / 100) / 12;
    const basePmt = monthlyPayment(principal, aprPct, termMonths);
    const totalPmt = basePmt + extraMonthly;
    
    let bal = principal;
    let totalInt = 0;
    for (let i = 0; i < monthsElapsed; i++) {
      const interest = bal * r;
      totalInt += interest;
      const principalPmt = totalPmt - interest;
      bal -= principalPmt;
      if (bal <= 0) break;
    }
    return totalInt;
  }

  function monthsToPayoff(principal, aprPct, termMonths, extraMonthly = 0) {
    const r = (aprPct / 100) / 12;
    const basePmt = monthlyPayment(principal, aprPct, termMonths);
    const totalPmt = basePmt + extraMonthly;
    
    let bal = principal;
    let months = 0;
    while (bal > 0 && months < termMonths * 2) {
      const interest = bal * r;
      const principalPmt = totalPmt - interest;
      bal -= principalPmt;
      months++;
    }
    return months;
  }

  // ================================
  // MARKET VALUE FUNCTIONS
  // ================================
  function splitPrivateTrade(midValue, tradeDiscountPct) {
    const spread = clamp(tradeDiscountPct / 100, 0, 0.40);
    const half = spread / 2;
    return {
      privateValue: midValue * (1 + half),
      tradeValue: midValue * (1 - half)
    };
  }

  function assessMileageImpact(actualMiles, years, segment, currentValue) {
    const typicalAnnualMiles = 12000;
    const expectedMiles = years * typicalAnnualMiles;
    const delta = actualMiles - expectedMiles;
    
    // Use segment-specific coefficient (% per 1,000 miles)
    // Coefficients are NEGATIVE (e.g., -0.45), meaning high mileage reduces value
    const coefficient = getMileageCoefficient(segment);
    const deltaThousands = delta / 1000;
    
    // Calculate as percentage of CURRENT value (not purchase price!)
    // If delta is positive (high mileage) and coefficient is negative, impact is negative (value loss)
    // If delta is negative (low mileage) and coefficient is negative, impact is positive (value gain)
    const percentageImpact = deltaThousands * coefficient;
    const dollarImpact = currentValue * (percentageImpact / 100);
    
    let status = "on target";
    if (delta > 5000) status = "high mileage";
    else if (delta < -5000) status = "low mileage";
    
    return { dollarImpact, delta, status };
  }

  // ================================
  // UI HELPERS
  // ================================
  function setWarn(msg) {
    const el = document.getElementById("warn");
    if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block"; el.textContent = msg;
  }

  function setInfo(msg) {
    const el = document.getElementById("info");
    if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block"; el.textContent = msg;
  }

  // ================================
  // MAIN CALCULATION
  // ================================
  let chartInstance = null;

  function calculate() {
    setWarn("");
    setInfo("");

    const year = readNumber("year");
    const make = readText("make");
    const model = readText("model");
    const segment = readText("segment");

    const purchasePrice = readNumber("price");
    const down = readNumber("down");
    const apr = readNumber("apr");
    const term = readNumber("term");
    const xYears = readNumber("years");
    const post5 = readNumber("post5");
    const tradeDisc = readNumber("tradeDisc");
    const condAdj = readNumber("condAdj");
    const currentMileage = readNumber("currentMileage");
    const mileageAtAnalysis = readNumber("mileageAtAnalysis");
    const extraPmt = readNumber("extraPmt");
    const maxPeriod = readNumber("maxPeriod");
    const insurance = readNumber("insurance");
    const maintenance = readNumber("maintenance");
    const registration = readNumber("registration");
    const includeOperatingCosts = document.getElementById("includeOperatingCosts").checked;

    // Validation
    if (!isFinite(purchasePrice) || purchasePrice <= 0) return setWarn("Purchase price must be positive.");
    if (!isFinite(down) || down < 0 || down > purchasePrice) return setWarn("Down payment must be between $0 and purchase price.");
    if (!isFinite(term) || term <= 0) return setWarn("Loan term must be greater than 0.");
    if (!isFinite(xYears) || xYears < 0) return setWarn("Analysis point must be 0 or greater.");

    // Build depreciation curve
    const maxYear = Math.max(10, Math.ceil(maxPeriod));
    const curve = buildDepreciationCurve(maxYear, post5, segment, make, model);

    const residual = interpolateResidual(xYears, curve);
    const midValueRaw = purchasePrice * residual;

    // Mileage impact (calculated as % of current depreciated value)
    const mileageAnalysis = assessMileageImpact(mileageAtAnalysis, xYears, segment, midValueRaw);
    const mileageAdjusted = midValueRaw + mileageAnalysis.dollarImpact;

    // Condition adjustment
    let midValue = mileageAdjusted * (1 + condAdj / 100);
    
    // Safety: vehicle value floor at $500 (prevents negative values from extreme depreciation/mileage)
    midValue = Math.max(500, midValue);

    const { privateValue, tradeValue } = splitPrivateTrade(midValue, tradeDisc);
    const avgValue = (privateValue + tradeValue) / 2;

    // Loan calculations
    const principal = purchasePrice - down;
    const basePmt = monthlyPayment(principal, apr, term);
    const monthsElapsed = Math.round(xYears * 12);
    const bal = remainingBalance(principal, apr, term, monthsElapsed, extraPmt);
    const equity = avgValue - bal;
    const payoffMonths = monthsToPayoff(principal, apr, term, extraPmt);
    const intPaid = totalInterestPaid(principal, apr, term, Math.min(monthsElapsed, payoffMonths), extraPmt);

    // Update KPIs
    document.getElementById("privateValue").textContent = fmtMoney(privateValue);
    document.getElementById("tradeValue").textContent = fmtMoney(tradeValue);
    document.getElementById("avgValue").textContent = fmtMoney(avgValue);
    document.getElementById("equity").textContent = fmtMoney(equity);

    document.getElementById("privateSub").textContent = `+${fmtPct(tradeDisc/2)} above market avg`;
    document.getElementById("tradeSub").textContent = `‚àí${fmtPct(tradeDisc/2)} below market avg`;

    const equityKpi = document.getElementById("equity-breakdown");
    equityKpi.className = equity >= 0 ? "kpi col-6 positive" : "kpi col-6 negative";
    document.getElementById("equitySub").textContent = equity >= 0 ? "‚úì Positive equity position" : "‚ö†Ô∏è Negative equity (underwater)";

    document.getElementById("pmt").textContent = fmtMoney(basePmt);
    document.getElementById("balance").textContent = fmtMoney(bal);
    document.getElementById("monthsElapsed").textContent = `After ${monthsElapsed} months`;
    document.getElementById("totalInterest").textContent = fmtMoney(intPaid);
    document.getElementById("payoffTime").textContent = `${payoffMonths} months`;
    document.getElementById("payoffSub").textContent = extraPmt > 0 ? `${term - payoffMonths} months saved` : "No extra payments";

    document.getElementById("residualPct").textContent = fmtPct(residual * 100);
    document.getElementById("totalDepr").textContent = fmtMoney(purchasePrice - avgValue);
    document.getElementById("mileageImpact").textContent = mileageAnalysis.status;
    document.getElementById("mileageSub").textContent = `${mileageAnalysis.delta > 0 ? '+' : ''}${mileageAnalysis.delta.toLocaleString()} miles vs typical (${fmtMoney(Math.abs(mileageAnalysis.dollarImpact))})`;
    document.getElementById("annualDepr").textContent = xYears > 0 ? fmtMoney((purchasePrice - avgValue) / xYears) : "$‚Äî";

    // Cost of ownership calculations
    // Cap payments at actual payoff time (loan might be paid off before exit point)
    const actualPaymentMonths = Math.min(monthsElapsed, payoffMonths);
    const totalPaymentsMade = down + (basePmt + extraPmt) * actualPaymentMonths;
    
    // Operating costs (conditional based on checkbox)
    const insuranceCost = includeOperatingCosts ? insurance * monthsElapsed : 0;
    const maintenanceCost = includeOperatingCosts ? (maintenance / 12) * monthsElapsed : 0;
    const registrationCost = includeOperatingCosts ? registration * xYears : 0;
    const totalOperatingCosts = insuranceCost + maintenanceCost + registrationCost;
    
    const equityRecovered = equity; // Net equity = vehicle value - remaining loan balance
    const netCostOfOwnership = totalPaymentsMade + totalOperatingCosts - equityRecovered;
    const monthlyCostOfOwnership = monthsElapsed > 0 ? netCostOfOwnership / monthsElapsed : 0;

    document.getElementById("totalPmts").textContent = fmtMoney(totalPaymentsMade);
    document.getElementById("totalPmtsSub").textContent = actualPaymentMonths < monthsElapsed 
      ? `Down + ${actualPaymentMonths} payments (loan paid off at ${(actualPaymentMonths/12).toFixed(1)} years)`
      : `Down payment + ${actualPaymentMonths} monthly payments`;
    document.getElementById("operatingCosts").textContent = fmtMoney(totalOperatingCosts);
    
    // Show/hide operating costs KPI based on checkbox
    const operatingCostsKpi = document.getElementById("operatingCostsKpi");
    operatingCostsKpi.style.display = includeOperatingCosts ? "block" : "none";
    
    // Update Net Cost subtitle based on whether operating costs are included
    document.getElementById("netCostSub").textContent = includeOperatingCosts 
      ? "Payments + operating costs ‚àí equity recovered" 
      : "Total payments ‚àí equity recovered";
    
    document.getElementById("equityRecovered").textContent = fmtMoney(equityRecovered);
    document.getElementById("netCost").textContent = fmtMoney(netCostOfOwnership);
    document.getElementById("monthlyCost").textContent = fmtMoney(monthlyCostOfOwnership);
    
    // Update Monthly Cost subtitle with comparison to actual payment
    const actualMonthlyPayment = basePmt + extraPmt;
    const monthlyCostSub = document.getElementById("monthlyCostSub");
    const costDifference = monthlyCostOfOwnership - actualMonthlyPayment;
    const costDifferenceAbs = Math.abs(costDifference);
    
    if (costDifference > 0) {
      // True cost is higher than payment (losing equity)
      monthlyCostSub.textContent = `Payment: ${fmtMoney(actualMonthlyPayment)}/mo ‚Ä¢ True cost is ${fmtMoney(costDifferenceAbs)}/mo higher`;
      monthlyCostSub.style.color = "#ef4444"; // Red
    } else if (costDifference < 0) {
      // True cost is lower than payment (building equity)
      monthlyCostSub.textContent = `Payment: ${fmtMoney(actualMonthlyPayment)}/mo ‚Ä¢ True cost is ${fmtMoney(costDifferenceAbs)}/mo lower`;
      monthlyCostSub.style.color = "#10b981"; // Green
    } else {
      // Equal
      monthlyCostSub.textContent = `Payment: ${fmtMoney(actualMonthlyPayment)}/mo ‚Ä¢ Same as true cost`;
      monthlyCostSub.style.color = "#94a3b8"; // Gray
    }

    // Color code Net Cost KPI with glowing positive effect
    const netCostKpi = document.getElementById("netCostKpi");
    netCostKpi.className = "kpi col-6 positive"; // Lower cost is always "positive" (good)
    
    // Color code equity recovered KPI and add explanatory subtitle
    const equityRecoveredKpi = document.getElementById("equityRecoveredKpi");
    const equityRecoveredSub = document.getElementById("equityRecoveredSub");
    
    if (equityRecovered >= 0) {
      equityRecoveredKpi.className = "kpi col-4 positive";
      equityRecoveredSub.textContent = `Cash you receive at ${xYears.toFixed(1)}-year exit point`;
    } else {
      equityRecoveredKpi.className = "kpi col-4 negative";
      equityRecoveredSub.textContent = `Cash needed to exit at ${xYears.toFixed(1)} years (adds to cost)`;
    }


    // Info message
    if (equity < 0) {
      setInfo(`‚ö†Ô∏è Vehicle is underwater by ${fmtMoney(Math.abs(equity))} at your ${xYears.toFixed(1)}-year exit point. You'll need to bring ${fmtMoney(Math.abs(equity))} cash to pay off the loan when you sell/trade, increasing your total cost of ownership. Consider: (1) making extra payments to close the gap, (2) extending your exit timeline, or (3) factoring this payoff cost into your next vehicle purchase.`);
    } else if (equity > 0 && equity < 3000) {
      setInfo(`üí° Small positive equity of ${fmtMoney(equity)} at your ${xYears.toFixed(1)}-year exit point. You'll receive ${fmtMoney(equity)} cash back when you sell/trade. Consider transaction costs (taxes, fees, dealer doc fees) when planning, as they may consume this equity.`);
    } else if (equity >= 3000) {
      setInfo(`‚úÖ Positive equity of ${fmtMoney(equity)} at your ${xYears.toFixed(1)}-year exit point. You'll receive ${fmtMoney(equity)} cash back when you sell/trade, reducing your total cost of ownership.`);
    }

    // Details table
    renderDetailsTable(year, make, model, segment, purchasePrice, down, principal, apr, term, xYears, 
                       residual, condAdj, tradeDisc, privateValue, tradeValue, avgValue, bal, equity,
                       currentMileage, mileageAtAnalysis, mileageAnalysis, extraPmt, intPaid, totalPaymentsMade, equityRecovered, netCostOfOwnership, monthlyCostOfOwnership, actualPaymentMonths, monthsElapsed);

    // Chart
    renderChart(curve, maxPeriod, purchasePrice, principal, apr, term, extraPmt, xYears, currentMileage, mileageAtAnalysis, condAdj, tradeDisc);

    // Display credit impact if credit score provided
    const creditImpactDiv = document.getElementById("creditImpact");
    const creditImpact = calculateCreditImpact();
    
    if (creditImpact) {
      const currentTier = getCreditTier(creditImpact.currentScore);
      let html = `<div style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #6495ED;">üí≥ Credit Impact Analysis</div>`;
      html += `<div style="margin-bottom: 10px;">Your <strong style="color: ${currentTier.color};">${currentTier.label}</strong> credit score (${creditImpact.currentScore}) qualifies for ~${creditImpact.currentAPR.toFixed(2)}% APR</div>`;
      
      if (creditImpact.savings > 0) {
        html += `<div style="color: #10b981; margin-bottom: 8px;">üü¢ <strong>Improve to ${creditImpact.betterScore}:</strong> Save ${fmtMoney(creditImpact.savings)} in total interest (${fmtMoney(creditImpact.currentMonthly - creditImpact.betterMonthly)}/mo less)</div>`;
      }
      
      if (creditImpact.costIncrease > 0) {
        html += `<div style="color: #ef4444;">üî¥ <strong>Drop to ${creditImpact.worseScore}:</strong> Pay ${fmtMoney(creditImpact.costIncrease)} more in interest (${fmtMoney(creditImpact.worseMonthly - creditImpact.currentMonthly)}/mo more)</div>`;
      }
      
      html += `<div style="margin-top: 12px; font-size: 12px; color: #94a3b8; font-style: italic;">Estimates based on national averages. Actual rates vary by lender.</div>`;
      
      creditImpactDiv.innerHTML = html;
      creditImpactDiv.style.display = "block";
    } else {
      creditImpactDiv.style.display = "none";
    }

    // Lease suggestion logic
    const leaseSuggestionDiv = document.getElementById("leaseSuggestion");
    const leaseDismissed = sessionStorage.getItem("leaseSuggestionDismissed");
    
    if (!leaseDismissed) {
      const depreciationRate = 1 - residual;
      const downPercent = (down / purchasePrice) * 100;
      const annualMiles = (mileageAtAnalysis - currentMileage) / xYears;
      
      let leaseScore = 0;
      const reasons = [];
      
      // Short ownership period
      if (xYears <= 2) {
        leaseScore += 40;
        reasons.push({ text: `Short ownership period (${xYears.toFixed(1)} years)`, points: 40 });
      } else if (xYears <= 3) {
        leaseScore += 25;
        reasons.push({ text: `Short ownership period (${xYears.toFixed(1)} years)`, points: 25 });
      } else if (xYears <= 4) {
        leaseScore += 10;
        reasons.push({ text: `Moderate ownership period (${xYears.toFixed(1)} years)`, points: 10 });
      }
      
      // Heavy depreciation
      if (depreciationRate > 0.50) {
        leaseScore += 25;
        reasons.push({ text: `High depreciation vehicle (${(depreciationRate * 100).toFixed(0)}% loss)`, points: 25 });
      } else if (depreciationRate > 0.40) {
        leaseScore += 15;
        reasons.push({ text: `Moderate depreciation (${(depreciationRate * 100).toFixed(0)}% loss)`, points: 15 });
      }
      
      // High APR + low down
      if (apr > 8 && downPercent < 10) {
        leaseScore += 20;
        reasons.push({ text: `High financing rate (${apr.toFixed(2)}%) with low down payment`, points: 20 });
      } else if (apr > 6 && downPercent < 15) {
        leaseScore += 10;
        reasons.push({ text: `Above-average APR (${apr.toFixed(2)}%)`, points: 10 });
      }
      
      // Negative/low equity
      if (equity < 0) {
        leaseScore += 30;
        reasons.push({ text: `Negative equity at exit (${fmtMoney(equity)})`, points: 30 });
      } else if (equity < purchasePrice * 0.05) {
        leaseScore += 15;
        reasons.push({ text: `Low equity at exit (only ${fmtMoney(equity)})`, points: 15 });
      }
      
      // Low mileage
      if (annualMiles < 10000) {
        leaseScore += 15;
        reasons.push({ text: `Low annual mileage (${Math.round(annualMiles).toLocaleString()} miles/year)`, points: 15 });
      } else if (annualMiles < 12000) {
        leaseScore += 10;
        reasons.push({ text: `Below-average mileage (${Math.round(annualMiles).toLocaleString()} miles/year)`, points: 10 });
      }
      
      // Show suggestion if score >= 45
      if (leaseScore >= 45) {
        // Sort by points and take top 3
        reasons.sort((a, b) => b.points - a.points);
        const topReasons = reasons.slice(0, 3);
        
        let html = `
          <button onclick="sessionStorage.setItem('leaseSuggestionDismissed', 'true'); document.getElementById('leaseSuggestion').style.display='none';" 
                  style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 20px; cursor: pointer; color: #059669; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0.6; transition: opacity 0.2s;"
                  onmouseover="this.style.opacity='1'" 
                  onmouseout="this.style.opacity='0.6'">√ó</button>
          <div style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #059669;">üí° Leasing Might Save You Money</div>
          <div style="margin-bottom: 10px;">Based on your situation, you should consider leasing:</div>
          <ul style="margin: 10px 0 12px 20px; padding: 0;">
        `;
        
        topReasons.forEach(reason => {
          html += `<li style="margin-bottom: 6px;">${reason.text}</li>`;
        });
        
        html += `
          </ul>
          <button onclick="document.getElementById('leaseTab').click();" 
                  style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: transform 0.2s, box-shadow 0.2s;"
                  onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.3)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            Compare with Lease Calculator ‚Üí
          </button>
        `;
        
        leaseSuggestionDiv.innerHTML = html;
        leaseSuggestionDiv.style.display = "block";
      } else {
        leaseSuggestionDiv.style.display = "none";
      }
    } else {
      leaseSuggestionDiv.style.display = "none";
    }

    document.getElementById("output").style.display = "block";
    
    // Show tabs after calculation
    document.getElementById("tabNav").style.display = "block";
    
    // Default to Results tab (without scrolling - user stays at calculate button)
    showTab('results', false);
  }

  function renderDetailsTable(year, make, model, segment, price, down, principal, apr, term, xYears,
                              residual, condAdj, tradeDisc, privateVal, tradeVal, avgVal, bal, equity,
                              currentMileage, mileageAtAnalysis, mileageAnalysis, extraPmt, intPaid, totalPaymentsMade, equityRecovered, netCostOfOwnership, monthlyCostOfOwnership, actualPaymentMonths, monthsElapsed) {
    const tbody = document.getElementById("detailsTable");
    tbody.innerHTML = "";
    
    const rows = [
      ["Vehicle", `${year} ${make} ${model}`, segment ? `${segment} segment calibration` : "Generic depreciation curve"],
      ["Purchase Price", fmtMoney(price), "Original vehicle cost"],
      ["Down Payment", fmtMoney(down), `${((down/price)*100).toFixed(1)}% of purchase price`],
      ["Financed Amount", fmtMoney(principal), "Amount borrowed"],
      ["Loan Terms", `${apr.toFixed(2)}% APR, ${term} months`, `Base payment: ${fmtMoney(monthlyPayment(principal, apr, term))}/mo`],
      ["Analysis Point", `${xYears.toFixed(1)} years`, `${Math.round(xYears * 12)} months elapsed`],
      ["Current Odometer", `${currentMileage.toLocaleString()} miles`, "Current mileage on vehicle"],
      ["Projected Odometer", `${mileageAtAnalysis.toLocaleString()} miles`, `At ${xYears.toFixed(1)} year analysis point`],
      ["Mileage Assessment", `${mileageAnalysis.status}`, `${mileageAnalysis.delta > 0 ? '+' : ''}${mileageAnalysis.delta.toLocaleString()} miles vs typical (${fmtMoney(Math.abs(mileageAnalysis.dollarImpact))} impact)`],
      ["Residual Value %", fmtPct(residual * 100), "From depreciation curve + adjustments"],
      ["Condition Adjustment", `${condAdj >= 0 ? '+' : ''}${condAdj.toFixed(1)}%`, condAdj === 0 ? "Average condition" : (condAdj > 0 ? "Above average" : "Below average")],
      ["Private Party Value", fmtMoney(privateVal), "Estimated selling price to individual"],
      ["Trade-In Value", fmtMoney(tradeVal), `Dealer trade-in (‚àí${fmtPct(tradeDisc)} discount)`],
      ["Market Value (Avg)", fmtMoney(avgVal), "Average of private & trade-in"],
      ["Remaining Balance", fmtMoney(bal), extraPmt > 0 ? `With $${extraPmt}/mo extra payment` : "Base payment schedule"],
      ["Interest Paid to Date", fmtMoney(intPaid), "Through analysis point"],
      ["Net Equity", fmtMoney(equity), equity >= 0 ? "‚úì Positive equity" : "‚ö†Ô∏è Negative equity"],
      ["Total Payments Made", fmtMoney(totalPaymentsMade), actualPaymentMonths < monthsElapsed ? `Down + ${actualPaymentMonths} payments (loan paid off)` : `Down + ${actualPaymentMonths} months of payments`],
      ["Net Proceeds at Exit", fmtMoney(equityRecovered), equityRecovered >= 0 ? "Cash received after loan payoff" : "Cash required to pay off loan (negative equity)"],
      ["Net Cost of Ownership", fmtMoney(netCostOfOwnership), "Total payments ‚àí net proceeds (negative proceeds add to cost)"],
      ["Monthly Cost of Ownership", fmtMoney(monthlyCostOfOwnership), "True monthly cost to own this vehicle"]
    ];

    for (const [cat, val, note] of rows) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><strong>${cat}</strong></td><td>${val}</td><td>${note}</td>`;
      tbody.appendChild(tr);
    }
  }

  function renderChart(curve, maxPeriod, purchasePrice, principal, apr, term, extraPmt, exitYears, currentMileage, mileageAtAnalysisPoint, conditionAdj, tradeDiscount) {
    const labels = [];
    const vehicleValues = [];
    const loanBalances = [];
    const equityLine = [];

    // Calculate miles per year based on exit point
    const milesPerYear = exitYears > 0 ? (mileageAtAnalysisPoint - currentMileage) / exitYears : 0;

    for (let y = 0; y <= maxPeriod; y += 0.25) {
      labels.push(y.toFixed(2));
      
      const residual = interpolateResidual(y, curve);
      const baseValue = purchasePrice * residual;
      
      // Calculate actual projected mileage at this point
      const projectedMileage = currentMileage + (milesPerYear * y);
      
      // Apply mileage impact for this time period (% of current depreciated value)
      const mileageImpact = assessMileageImpact(projectedMileage, y, segment, baseValue);
      const mileageAdjusted = baseValue + mileageImpact.dollarImpact;
      
      // Apply condition adjustment
      const conditionAdjusted = mileageAdjusted * (1 + conditionAdj / 100);
      
      // Apply trade discount to get average value
      const { privateValue, tradeValue } = splitPrivateTrade(conditionAdjusted, tradeDiscount);
      const avgValue = (privateValue + tradeValue) / 2;
      
      vehicleValues.push(avgValue);

      const months = Math.round(y * 12);
      const balance = remainingBalance(principal, apr, term, months, extraPmt);
      loanBalances.push(balance);

      equityLine.push(avgValue - balance);
    }

    const ctx = document.getElementById("equityChart").getContext("2d");
    
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Vehicle Value",
            data: vehicleValues,
            borderColor: "#0066cc",
            backgroundColor: "rgba(0, 102, 204, 0.1)",
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 0
          },
          {
            label: "Loan Balance",
            data: loanBalances,
            borderColor: "#dc2626",
            backgroundColor: "rgba(220, 38, 38, 0.1)",
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 0
          },
          {
            label: "Net Equity",
            data: equityLine,
            borderColor: "#059669",
            backgroundColor: "rgba(5, 150, 105, 0.05)",
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            tension: 0.3,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false
        },
        plugins: {
          legend: {
            position: "top",
            labels: { font: { size: 13, weight: "600" }, padding: 15 }
          },
          tooltip: {
            backgroundColor: "rgba(0, 0, 0, 0.85)",
            padding: 12,
            titleFont: { size: 13, weight: "600" },
            bodyFont: { size: 12 },
            callbacks: {
              title: (items) => `Year ${parseFloat(items[0].label).toFixed(1)}`,
              label: (context) => {
                const val = context.parsed.y;
                return `${context.dataset.label}: ${fmtMoney(val)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: "Years from Purchase", font: { size: 13, weight: "600" } },
            grid: { display: false }
          },
          y: {
            title: { display: true, text: "Amount ($)", font: { size: 13, weight: "600" } },
            ticks: {
              callback: (value) => fmtMoney(value)
            },
            grid: { color: "rgba(0, 0, 0, 0.05)" }
          }
        },
        plugins: {
          annotation: {
            annotations: {
              exitPoint: {
                type: 'line',
                xMin: exitYears.toFixed(2),
                xMax: exitYears.toFixed(2),
                borderColor: '#fbbf24',
                borderWidth: 3,
                borderDash: [8, 4],
                label: {
                  display: true,
                  content: `Your Exit Point (${exitYears} yr)`,
                  position: 'start',
                  backgroundColor: 'rgba(251, 191, 36, 0.9)',
                  color: '#fff',
                  font: {
                    size: 11,
                    weight: 'bold'
                  },
                  padding: 6,
                  borderRadius: 4
                }
              }
            }
          }
        }
      }
    });
  }

  // ================================
  // SCENARIO COMPARISON
  // ================================
  function compareScenarios() {
    const baseInputs = {
      year: readNumber("year"),
      make: readText("make"),
      model: readText("model"),
      segment: readText("segment"),
      price: readNumber("price"),
      down: readNumber("down"),
      apr: readNumber("apr"),
      term: readNumber("term"),
      years: readNumber("years"),
      post5: readNumber("post5"),
      tradeDisc: readNumber("tradeDisc"),
      condAdj: readNumber("condAdj"),
      mileageAtAnalysis: readNumber("mileageAtAnalysis"),
      extraPmt: readNumber("extraPmt")
    };

    const scenarios = [
      { name: "Current Plan", ...baseInputs },
      { name: "Higher Down Payment", ...baseInputs, down: baseInputs.down + 5000 },
      { name: "+$100/mo Extra", ...baseInputs, extraPmt: baseInputs.extraPmt + 100 },
      { name: "+$200/mo Extra", ...baseInputs, extraPmt: baseInputs.extraPmt + 200 },
      { name: "36-Month Loan", ...baseInputs, term: 36 },
      { name: "72-Month Loan", ...baseInputs, term: 72 }
    ];

    const results = scenarios.map(s => {
      const maxYear = Math.max(10, Math.ceil(s.years));
      const curve = buildDepreciationCurve(maxYear, s.post5, s.segment, s.make, s.model);
      
      const residual = interpolateResidual(s.years, curve);
      const midValueRaw = s.price * residual;
      const mileageAnalysis = assessMileageImpact(s.mileageAtAnalysis, s.years, s.segment, midValueRaw);
      const midValue = (midValueRaw + mileageAnalysis.dollarImpact) * (1 + s.condAdj / 100);
      const { privateValue, tradeValue } = splitPrivateTrade(midValue, s.tradeDisc);
      const avgValue = (privateValue + tradeValue) / 2;
      
      const principal = s.price - s.down;
      const basePmt = monthlyPayment(principal, s.apr, s.term);
      const monthsElapsed = Math.round(s.years * 12);
      const bal = remainingBalance(principal, s.apr, s.term, monthsElapsed, s.extraPmt);
      const equity = avgValue - bal;
      
      // Calculate when loan is actually paid off
      const payoffMonths = monthsToPayoff(principal, s.apr, s.term, s.extraPmt);
      
      // Cost at user's exit point (apples-to-apples comparison)
      // Cap payments at actual payoff time (loan might be paid off before exit)
      const actualPaymentMonths = Math.min(monthsElapsed, payoffMonths);
      const totalPaymentsMade = s.down + (basePmt + s.extraPmt) * actualPaymentMonths;
      const equityRecovered = equity;
      const netCostAtExit = totalPaymentsMade - equityRecovered;
      
      // Interest paid through exit point
      const interestPaidAtExit = totalInterestPaid(principal, s.apr, s.term, Math.min(monthsElapsed, payoffMonths), s.extraPmt);
      
      // Cost if held until loan payoff
      const payoffYears = payoffMonths / 12;
      const totalPaymentsToPayoff = s.down + (basePmt + s.extraPmt) * payoffMonths;
      
      // Interest paid through payoff
      const interestPaidAtPayoff = totalInterestPaid(principal, s.apr, s.term, payoffMonths, s.extraPmt);
      
      // Vehicle value at payoff
      const residualAtPayoff = interpolateResidual(payoffYears, curve);
      const midValueAtPayoff = s.price * residualAtPayoff;
      const mileageAtPayoff = (s.mileageAtAnalysis / s.years) * payoffYears; // project mileage
      const mileageAnalysisPayoff = assessMileageImpact(mileageAtPayoff, payoffYears, s.segment, midValueAtPayoff);
      const adjustedValueAtPayoff = (midValueAtPayoff + mileageAnalysisPayoff.dollarImpact) * (1 + s.condAdj / 100);
      const { privateValue: pvPayoff, tradeValue: tvPayoff } = splitPrivateTrade(adjustedValueAtPayoff, s.tradeDisc);
      const valueAtPayoff = (pvPayoff + tvPayoff) / 2;
      
      const netCostAtPayoff = totalPaymentsToPayoff - valueAtPayoff; // At payoff, balance is $0, so equity = vehicle value
      
      return {
        name: s.name,
        payment: basePmt + s.extraPmt,
        equity,
        balance: bal,
        value: avgValue,
        netCostAtExit,
        totalPayments: totalPaymentsMade,
        payoffMonths,
        netCostAtPayoff,
        valueAtPayoff,
        interestPaidAtExit,
        interestPaidAtPayoff
      };
    });

    const grid = document.getElementById("scenarioGrid");
    grid.innerHTML = "";
    
    // Get the user's chosen exit point for consistent display
    const exitYears = baseInputs.years;
    const exitMonths = Math.round(exitYears * 12);
    
    // Find best and worst scenarios
    const basePayment = results[0].payment;
    const baseCostAtExit = results[0].netCostAtExit;
    const baseCostAtPayoff = results[0].netCostAtPayoff;
    
    // Find scenario with most savings (regardless of payment)
    const mostSavings = results.reduce((best, r) => {
      if (r === results[0]) return best; // Skip base scenario
      const savings = baseCostAtPayoff - r.netCostAtPayoff;
      const bestSavings = baseCostAtPayoff - best.netCostAtPayoff;
      return savings > bestSavings ? r : best;
    }, results[0]);
    
    // Find "Best Value" - saves money AND payment within 30% of base
    const affordableThreshold = basePayment * 1.30;
    const bestValue = results.reduce((best, r) => {
      if (r === results[0]) return best; // Skip base scenario
      if (r.payment > affordableThreshold) return best; // Too expensive monthly
      
      const savings = baseCostAtPayoff - r.netCostAtPayoff;
      const bestSavings = baseCostAtPayoff - best.netCostAtPayoff;
      
      return (savings > bestSavings && savings > 0) ? r : best;
    }, results[0]);
    
    const worstScenario = results.reduce((worst, r) => 
      r.netCostAtPayoff > worst.netCostAtPayoff ? r : worst
    );
    
    results.forEach((r, i) => {
      const card = document.createElement("div");
      const isActive = i === 0;
      const isMostSavings = r === mostSavings && r !== results[0];
      const isBestValue = r === bestValue && r !== results[0] && r !== mostSavings;
      const isWorst = r === worstScenario && r !== results[0];
      
      card.className = "scenario-card" + (isActive ? " active" : "");
      const costColor = '#6495ED';
      const equityColor = r.equity >= 0 ? '#10b981' : '#ef4444';
      
      // Calculate savings vs base scenario
      const savingsAtExit = baseCostAtExit - r.netCostAtExit;
      const savingsAtPayoff = baseCostAtPayoff - r.netCostAtPayoff;
      
      // Payment increase percentage
      const paymentIncreasePct = ((r.payment - basePayment) / basePayment) * 100;
      
      // Badge logic
      let badge = '';
      if (isMostSavings) {
        badge = '<div style="display: inline-block; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em; margin-left: 8px;">üíé MOST SAVINGS</div>';
      } else if (isBestValue) {
        badge = '<div style="display: inline-block; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em; margin-left: 8px;">üèÜ BEST VALUE</div>';
      } else if (isWorst) {
        badge = '<div style="display: inline-block; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em; margin-left: 8px;">‚ö†Ô∏è HIGHEST COST</div>';
      }
      
      card.innerHTML = `
        <h4 style="display: flex; align-items: center; flex-wrap: wrap;">${r.name}${badge}</h4>
        
        <div style="margin: 8px 0;">
          <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Cost at Exit (${exitMonths} mo)</div>
          <div class="scenario-val" style="color: ${costColor}; font-size: 24px;">${fmtMoney(r.netCostAtExit)}</div>
          ${!isActive && savingsAtExit !== 0 ? `
            <div style="font-size: 12px; font-weight: 600; margin-top: 4px; color: ${savingsAtExit > 0 ? '#10b981' : '#ef4444'};">
              ${savingsAtExit > 0 ? '‚úì' : '‚úó'} ${fmtMoney(Math.abs(savingsAtExit))} ${savingsAtExit > 0 ? 'saved' : 'more'} vs Current
            </div>
          ` : ''}
        </div>
        
        <div style="margin: 8px 0; padding: 8px; background: #f8fafc; border-radius: 6px;">
          <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 3px;">If Held to Payoff (${r.payoffMonths} mo)</div>
          <div style="font-size: 16px; font-weight: 700; color: #475569;">${fmtMoney(r.netCostAtPayoff)}</div>
          ${!isActive && savingsAtPayoff !== 0 ? `
            <div style="font-size: 11px; font-weight: 600; margin-top: 3px; color: ${savingsAtPayoff > 0 ? '#10b981' : '#ef4444'};">
              ${savingsAtPayoff > 0 ? '‚úì' : '‚úó'} ${fmtMoney(Math.abs(savingsAtPayoff))} ${savingsAtPayoff > 0 ? 'saved' : 'more'}
            </div>
          ` : ''}
        </div>
        
        <div style="margin: 12px 0 0; padding-top: 12px; border-top: 1px solid #e2e8f0;">
          <div class="scenario-sub">
            Payment: ${fmtMoney(r.payment)}/mo
            ${!isActive && paymentIncreasePct !== 0 ? `
              <span style="color: ${paymentIncreasePct > 0 ? '#f59e0b' : '#10b981'}; font-weight: 600; margin-left: 4px;">
                (${paymentIncreasePct > 0 ? '+' : ''}${paymentIncreasePct.toFixed(0)}%)
              </span>
            ` : ''}
          </div>
          <div class="scenario-sub" style="color: ${equityColor};">Exit Equity: ${fmtMoney(r.equity)}</div>
          <div class="scenario-sub" style="color: #f59e0b;">Interest Paid: ${fmtMoney(r.interestPaidAtPayoff)}</div>
        </div>
      `;
      grid.appendChild(card);
    });

    document.getElementById("scenarioOutput").style.display = "block";
  }

  // ================================
  // TAB SWITCHING
  // ================================
  function showTab(tab, shouldScroll = true) {
    const resultsTab = document.getElementById('resultsTab');
    const compareTab = document.getElementById('compareTab');
    const vehiclesTab = document.getElementById('vehiclesTab');
    const leaseTab = document.getElementById('leaseTab');
    const outputDiv = document.getElementById('output');
    const scenarioDiv = document.getElementById('scenarioOutput');
    const vehiclesDiv = document.getElementById('vehiclesOutput');
    const leaseDiv = document.getElementById('leaseOutput');
    const tabNav = document.getElementById('tabNav');
    
    // Remove active from all tabs and update ARIA
    resultsTab.classList.remove('active');
    resultsTab.setAttribute('aria-selected', 'false');
    compareTab.classList.remove('active');
    compareTab.setAttribute('aria-selected', 'false');
    vehiclesTab.classList.remove('active');
    vehiclesTab.setAttribute('aria-selected', 'false');
    leaseTab.classList.remove('active');
    leaseTab.setAttribute('aria-selected', 'false');
    
    // Hide all divs
    outputDiv.style.display = 'none';
    scenarioDiv.style.display = 'none';
    vehiclesDiv.style.display = 'none';
    leaseDiv.style.display = 'none';
    
    if (tab === 'results') {
      resultsTab.classList.add('active');
      resultsTab.setAttribute('aria-selected', 'true');
      outputDiv.style.display = 'block';
    } else if (tab === 'compare') {
      compareTab.classList.add('active');
      compareTab.setAttribute('aria-selected', 'true');
      scenarioDiv.style.display = 'block';
    } else if (tab === 'vehicles') {
      vehiclesTab.classList.add('active');
      vehiclesTab.setAttribute('aria-selected', 'true');
      vehiclesDiv.style.display = 'block';
    } else if (tab === 'lease') {
      leaseTab.classList.add('active');
      leaseTab.setAttribute('aria-selected', 'true');
      leaseDiv.style.display = 'block';
    }
    
    // Only scroll when explicitly switching tabs (not on initial calculation)
    if (shouldScroll) {
      tabNav.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ================================
  // LEASE CALCULATOR
  // ================================
  function calculateLease() {
    // Read lease inputs
    const msrp = readNumber("leaseMSRP");
    const agreedPrice = readNumber("leaseAgreedPrice");
    const down = readNumber("leaseDown");
    const term = readNumber("leaseTerm");
    const residualPercent = readNumber("leaseResidual");
    const moneyFactor = parseFloat(document.getElementById("leaseMoneyFactor").value) || 0.00125;
    const mileageAllowance = readNumber("leaseMileage");
    const acquisitionFee = readNumber("leaseAcquisitionFee");
    const dispositionFee = readNumber("leaseDispositionFee");
    const taxRate = readNumber("leaseTaxRate") / 100;
    const registration = readNumber("leaseRegistration");

    // Validation
    if (!agreedPrice || agreedPrice <= 0) {
      alert("Please enter a valid agreed upon price.");
      return;
    }

    // Calculate adjusted capitalized cost (net cap cost)
    const netCapCost = agreedPrice - down + acquisitionFee;

    // Calculate residual value in dollars
    const residualValue = agreedPrice * (residualPercent / 100);

    // Calculate depreciation (how much the car loses value)
    const totalDepreciation = agreedPrice - residualValue;
    const monthlyDepreciation = totalDepreciation / term;

    // Calculate finance charge (rent charge)
    const monthlyFinanceCharge = (netCapCost + residualValue) * moneyFactor;

    // Base monthly payment (before tax)
    const baseMonthlyPayment = monthlyDepreciation + monthlyFinanceCharge;

    // Monthly payment with tax
    const monthlyPaymentWithTax = baseMonthlyPayment * (1 + taxRate);

    // Total payments over lease term
    const totalMonthlyPayments = monthlyPaymentWithTax * term;

    // Total interest/finance charges over lease
    const totalInterestCharges = monthlyFinanceCharge * term;

    // Due at signing
    const dueAtSigning = down + monthlyPaymentWithTax + registration;

    // Total lease cost (everything you pay)
    const totalLeaseCost = dueAtSigning + (monthlyPaymentWithTax * (term - 1)) + dispositionFee;

    // Cost per month owned
    const costPerMonthOwned = totalLeaseCost / term;

    // Display results
    document.getElementById("leaseMonthlyPayment").textContent = fmtMoney(monthlyPaymentWithTax);
    document.getElementById("leaseTotalCost").textContent = fmtMoney(totalLeaseCost);
    document.getElementById("leaseCostPerMonth").textContent = fmtMoney(costPerMonthOwned);
    document.getElementById("leaseBasePayment").textContent = fmtMoney(baseMonthlyPayment);
    document.getElementById("leaseDepreciation").textContent = fmtMoney(totalDepreciation);
    document.getElementById("leaseInterest").textContent = fmtMoney(totalInterestCharges);
    document.getElementById("leaseDueAtSigning").textContent = fmtMoney(dueAtSigning);
    document.getElementById("leaseResidualValue").textContent = fmtMoney(residualValue);

    // Show results
    document.getElementById("leaseResults").style.display = "block";

    // Store lease data for comparison
    window.currentLeaseData = {
      year: readNumber("leaseYear"),
      make: document.getElementById("leaseMake").value,
      model: document.getElementById("leaseModel").value,
      segment: document.getElementById("leaseSegment").value,
      msrp: msrp,
      agreedPrice: agreedPrice,
      down: down,
      term: term,
      monthlyPayment: monthlyPaymentWithTax,
      totalCost: totalLeaseCost,
      costPerMonth: costPerMonthOwned,
      residualValue: residualValue,
      mileageAllowance: mileageAllowance,
      type: 'lease'
    };
  }

  function addLeaseToComparison() {
    if (!window.currentLeaseData) {
      alert("Please calculate a lease first before adding to comparison.");
      return;
    }

    if (comparisonVehicles.length >= 3) {
      alert('Maximum 3 vehicles can be compared at once.');
      return;
    }

    const leaseData = window.currentLeaseData;
    leaseData.id = nextVehicleId++;
    
    comparisonVehicles.push(leaseData);
    renderVehicleComparison();
    showTab('vehicles');
  }

  // ================================
  // VEHICLE COMPARISON
  // ================================
  let comparisonVehicles = [];
  let nextVehicleId = 1;

  function addVehicleToComparison() {
    if (comparisonVehicles.length >= 3) {
      alert('Maximum 3 vehicles can be compared at once.');
      return;
    }

    // Get current vehicle data from main form
    const vehicle = {
      id: nextVehicleId++,
      year: readNumber("year"),
      make: readText("make"),
      model: readText("model"),
      segment: readText("segment"),
      price: readNumber("price"),
      down: readNumber("down"),
      apr: readNumber("apr"),
      term: readNumber("term"),
      years: readNumber("years"),
      currentMileage: readNumber("currentMileage"),
      mileageAtAnalysis: readNumber("mileageAtAnalysis"),
      condAdj: readNumber("condAdj"),
      post5: readNumber("post5"),
      tradeDisc: readNumber("tradeDisc"),
      extraPmt: readNumber("extraPmt")
    };

    comparisonVehicles.push(vehicle);
    renderVehicleComparison();
    showTab('vehicles');
  }

  function removeVehicleFromComparison(id) {
    comparisonVehicles = comparisonVehicles.filter(v => v.id !== id);
    renderVehicleComparison();
  }

  function updateVehicleField(id, field, value) {
    const vehicle = comparisonVehicles.find(v => v.id === id);
    if (vehicle) {
      vehicle[field] = parseFloat(value) || 0;
      renderVehicleComparison();
    }
  }

  function renderVehicleComparison() {
    const grid = document.getElementById('vehicleComparisonGrid');
    const noVehiclesMsg = document.getElementById('noVehiclesMessage');
    const syncFinancing = document.getElementById('syncFinancing').checked;

    if (comparisonVehicles.length === 0) {
      grid.style.display = 'none';
      noVehiclesMsg.style.display = 'block';
      return;
    }

    grid.style.display = 'grid';
    noVehiclesMsg.style.display = 'none';
    grid.innerHTML = '';

    // Calculate results for each vehicle (finance or lease)
    const results = comparisonVehicles.map(v => {
      if (v.type === 'lease') {
        // Lease vehicle - use stored data
        return {
          vehicle: v,
          netCost: v.totalCost,
          monthlyCost: v.costPerMonth,
          monthlyPayment: v.monthlyPayment,
          equity: 0, // Leases have no equity
          totalPayments: v.totalCost,
          isLease: true
        };
      } else {
        // Finance vehicle - calculate as before
        const maxYear = Math.max(10, Math.ceil(v.years));
        const curve = buildDepreciationCurve(maxYear, v.post5, v.segment, v.make, v.model);
        
        const residual = interpolateResidual(v.years, curve);
        const midValueRaw = v.price * residual;
        const mileageAnalysis = assessMileageImpact(v.mileageAtAnalysis, v.years, v.segment, midValueRaw);
        const midValue = (midValueRaw + mileageAnalysis.dollarImpact) * (1 + v.condAdj / 100);
        const { privateValue, tradeValue } = splitPrivateTrade(midValue, v.tradeDisc);
        const avgValue = (privateValue + tradeValue) / 2;
        
        const principal = v.price - v.down;
        const basePmt = monthlyPayment(principal, v.apr, v.term);
        const monthsElapsed = Math.round(v.years * 12);
        const bal = remainingBalance(principal, v.apr, v.term, monthsElapsed, v.extraPmt);
        const equity = avgValue - bal;
        
        // Cap payments at actual payoff time
        const payoffMonths = monthsToPayoff(principal, v.apr, v.term, v.extraPmt);
        const actualPaymentMonths = Math.min(monthsElapsed, payoffMonths);
        const totalPaymentsMade = v.down + (basePmt + v.extraPmt) * actualPaymentMonths;
        const equityRecovered = equity;
        const netCostOfOwnership = totalPaymentsMade - equityRecovered;
        const monthlyCostOfOwnership = monthsElapsed > 0 ? netCostOfOwnership / monthsElapsed : 0;

        return {
          vehicle: v,
          netCost: netCostOfOwnership,
          monthlyCost: monthlyCostOfOwnership,
          monthlyPayment: basePmt + v.extraPmt,
          equity: equityRecovered,
          totalPayments: totalPaymentsMade,
          isLease: false
        };
      }
    });

    // Find best vehicle (lowest net cost)
    const bestVehicle = results.reduce((best, r) => r.netCost < best.netCost ? r : best);

    // Render each vehicle card
    results.forEach(result => {
      const v = result.vehicle;
      const isBest = result === bestVehicle && results.length > 1;
      const isLease = result.isLease;
      
      const card = document.createElement('div');
      card.style.cssText = `
        border: 2px solid ${isBest ? '#10b981' : (isLease ? 'rgba(16, 185, 129, 0.4)' : 'rgba(100, 149, 237, 0.3)')};
        border-radius: 18px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.5) 100%);
        backdrop-filter: blur(10px);
        position: relative;
        ${isBest ? 'box-shadow: 0 0 40px rgba(16, 185, 129, 0.3);' : ''}
      `;

      const typeBadge = isLease 
        ? '<span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-left: 8px;">üü¢ LEASE</span>'
        : '<span style="background: linear-gradient(135deg, #6495ED 0%, #4169E1 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-left: 8px;">üîµ FINANCE</span>';

      const bestBadge = isBest ? '<span style="margin-left: 8px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">üèÜ BEST VALUE</span>' : '';

      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
          <div>
            <h3 style="margin: 0 0 8px; color: #f1f5f9; font-size: 18px;">
              ${v.year} ${v.make} ${v.model}
              ${typeBadge}
              ${bestBadge}
            </h3>
            <div style="color: #94a3b8; font-size: 13px;">${v.segment || 'Generic'} Segment</div>
          </div>
          <button onclick="removeVehicleFromComparison(${v.id})" style="background: rgba(239, 68, 68, 0.2); border: 2px solid rgba(239, 68, 68, 0.4); color: #ef4444; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">
            ‚úï Remove
          </button>
        </div>

        <div style="background: ${isLease ? 'rgba(16, 185, 129, 0.1)' : 'rgba(100, 149, 237, 0.1)'}; border: 2px solid ${isLease ? 'rgba(16, 185, 129, 0.3)' : 'rgba(100, 149, 237, 0.3)'}; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px;">${isLease ? 'Total Lease Cost' : 'Net Cost of Ownership'}</div>
          <div style="font-size: 32px; font-weight: 800; color: ${isBest ? '#10b981' : (isLease ? '#10b981' : '#6495ED')}; letter-spacing: -0.02em;">${fmtMoney(result.netCost)}</div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">${fmtMoney(result.monthlyCost)}/month average</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">Monthly Payment</div>
            <div style="font-size: 18px; font-weight: 700; color: #cbd5e1;">${fmtMoney(result.monthlyPayment)}</div>
          </div>
          <div>
            <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">${isLease ? 'Equity (None)' : 'Net Proceeds'}</div>
            <div style="font-size: 18px; font-weight: 700; color: ${result.equity >= 0 ? '#10b981' : '#ef4444'};">${isLease ? '$0' : fmtMoney(result.equity)}</div>
          </div>
        </div>

        <div style="border-top: 1px solid rgba(100, 149, 237, 0.2); padding-top: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #94a3b8;">
            ${isLease ? `
              <div>MSRP: <span style="color: #cbd5e1; font-weight: 600;">${fmtMoney(v.msrp)}</span></div>
              <div>Agreed: <span style="color: #cbd5e1; font-weight: 600;">${fmtMoney(v.agreedPrice)}</span></div>
              <div>Term: <span style="color: #cbd5e1; font-weight: 600;">${v.term} mo</span></div>
              <div>Mileage: <span style="color: #cbd5e1; font-weight: 600;">${(v.mileageAllowance / 1000)}k/yr</span></div>
              <div>Down: <span style="color: #cbd5e1; font-weight: 600;">${fmtMoney(v.down)}</span></div>
              <div>Residual: <span style="color: #cbd5e1; font-weight: 600;">${fmtMoney(v.residualValue)}</span></div>
            ` : `
              <div>Price: <span style="color: #cbd5e1; font-weight: 600;">${fmtMoney(v.price)}</span></div>
              <div>Down: <span style="color: #cbd5e1; font-weight: 600;">${fmtMoney(v.down)}</span></div>
              <div>APR: <span style="color: #cbd5e1; font-weight: 600;">${v.apr.toFixed(2)}%</span></div>
              <div>Term: <span style="color: #cbd5e1; font-weight: 600;">${v.term} mo</span></div>
              <div>Exit: <span style="color: #cbd5e1; font-weight: 600;">${v.years} yr</span></div>
              <div>Extra: <span style="color: #cbd5e1; font-weight: 600;">${fmtMoney(v.extraPmt)}/mo</span></div>
            `}
          </div>
        </div>
      `;

      grid.appendChild(card);
    });
  }

  // ================================
  // CREDIT SCORE & APR ESTIMATION
  // ================================
  
  // Credit score tiers and typical APR ranges
  const CREDIT_TIERS = {
    excellent: { min: 740, max: 850, aprMin: 3.5, aprMax: 5.5, color: "#10b981", label: "Excellent" },
    good: { min: 670, max: 739, aprMin: 5.5, aprMax: 7.5, color: "#6495ED", label: "Good" },
    fair: { min: 580, max: 669, aprMin: 7.5, aprMax: 12, color: "#f59e0b", label: "Fair" },
    poor: { min: 300, max: 579, aprMin: 12, aprMax: 18, color: "#ef4444", label: "Poor" }
  };
  
  function getCreditTier(score) {
    if (!score || score < 300 || score > 850) return null;
    
    for (const [key, tier] of Object.entries(CREDIT_TIERS)) {
      if (score >= tier.min && score <= tier.max) {
        return { key, ...tier };
      }
    }
    return null;
  }
  
  function suggestAPRFromCredit(score) {
    const tier = getCreditTier(score);
    if (!tier) return null;
    
    // Return mid-point of range
    return (tier.aprMin + tier.aprMax) / 2;
  }
  
  function updateCreditTierDisplay() {
    const score = parseInt(document.getElementById("creditScore").value);
    const tierText = document.getElementById("creditTierText");
    const aprInput = document.getElementById("apr");
    
    if (!score || score < 300 || score > 850) {
      tierText.textContent = "Private - used for rate estimates only";
      tierText.style.color = "#94a3b8";
      return;
    }
    
    const tier = getCreditTier(score);
    if (tier) {
      tierText.innerHTML = `<strong style="color: ${tier.color};">${tier.label}</strong> ‚Ä¢ Est. APR: ${tier.aprMin}% - ${tier.aprMax}%`;
      tierText.style.color = tier.color;
      
      // Auto-suggest APR (mid-point of range)
      const suggestedAPR = suggestAPRFromCredit(score);
      if (suggestedAPR && (!aprInput.value || confirm(`Update APR to ${suggestedAPR.toFixed(2)}% based on your credit score?`))) {
        aprInput.value = suggestedAPR.toFixed(2);
      }
    }
  }
  
  function calculateCreditImpact() {
    const currentScore = parseInt(document.getElementById("creditScore").value);
    if (!currentScore || currentScore < 300 || currentScore > 850) return null;
    
    const currentAPR = readNumber("apr");
    const principal = readNumber("price") - readNumber("down");
    const term = readNumber("term");
    
    if (!principal || !term) return null;
    
    // Calculate with better credit (760)
    const betterScore = 760;
    const betterAPR = suggestAPRFromCredit(betterScore);
    const currentMonthly = monthlyPayment(principal, currentAPR, term);
    const betterMonthly = monthlyPayment(principal, betterAPR, term);
    const currentTotal = currentMonthly * term;
    const betterTotal = betterMonthly * term;
    const savings = currentTotal - betterTotal;
    
    // Calculate with worse credit (650)
    const worseScore = 650;
    const worseAPR = suggestAPRFromCredit(worseScore);
    const worseMonthly = monthlyPayment(principal, worseAPR, term);
    const worseTotal = worseMonthly * term;
    const costIncrease = worseTotal - currentTotal;
    
    return {
      currentScore,
      currentAPR,
      betterScore,
      betterAPR,
      savings,
      worseScore,
      worseAPR,
      costIncrease,
      currentMonthly,
      betterMonthly,
      worseMonthly
    };
  }

  // ================================
  // EVENT LISTENERS
  // ================================
  
  // Populate model dropdown when make is selected
  // Handle Make selection - populate Models
  document.getElementById("make").addEventListener("change", function() {
    const make = this.value;
    const modelSelect = document.getElementById("model");
    const trimSelect = document.getElementById("trim");
    
    // Clear model and trim
    modelSelect.innerHTML = '<option value="">Select Model...</option>';
    trimSelect.innerHTML = '<option value="">Select Model First...</option>';
    document.getElementById("price").value = "";
    
    if (make && VEHICLE_DATABASE[make]) {
      const models = Object.keys(VEHICLE_DATABASE[make]).sort();
      models.forEach(model => {
        const option = document.createElement("option");
        option.value = model;
        option.textContent = model;
        modelSelect.appendChild(option);
      });
    }
  });

  // Handle Model selection - populate Trims
  document.getElementById("model").addEventListener("change", function() {
    const make = document.getElementById("make").value;
    const model = this.value;
    const trimSelect = document.getElementById("trim");
    
    // Clear trim
    trimSelect.innerHTML = '<option value="">Select Trim...</option>';
    document.getElementById("price").value = "";
    
    // Auto-populate segment based on make/model
    if (make && model) {
      const segment = getModelSegment(make, model);
      document.getElementById("segment").value = segment;
    }
    
    if (make && model && VEHICLE_DATABASE[make] && VEHICLE_DATABASE[make][model]) {
      const trims = VEHICLE_DATABASE[make][model];
      trims.forEach(trimData => {
        const option = document.createElement("option");
        option.value = trimData.trim;
        option.textContent = `${trimData.trim} - ${fmtMoney(trimData.msrp)}`;
        option.dataset.msrp = trimData.msrp;
        trimSelect.appendChild(option);
      });
      
      // Auto-select first trim
      if (trims.length > 0) {
        trimSelect.selectedIndex = 1; // Select first actual trim (not placeholder)
        trimSelect.dispatchEvent(new Event("change"));
      }
    }
  });

  // Handle Trim selection - populate Price
  document.getElementById("trim").addEventListener("change", function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption && selectedOption.dataset.msrp) {
      const year = readNumber("year");
      const make = readText("make");
      const model = readText("model");
      const msrp = parseInt(selectedOption.dataset.msrp);
      
      // Use smart depreciation-based pricing
      const suggestedPrice = calculateSuggestedPrice(year, make, model, msrp);
      document.getElementById("price").value = suggestedPrice;
    }
  });

  // Auto-populate purchase price when year changes
  function updatePurchasePrice() {
    const trimSelect = document.getElementById("trim");
    if (trimSelect.selectedIndex > 0) {
      trimSelect.dispatchEvent(new Event("change"));
    }
  }

  document.getElementById("year").addEventListener("change", updatePurchasePrice);
  document.getElementById("make").addEventListener("change", updatePurchasePrice);

  document.getElementById("calcBtn").addEventListener("click", () => {
    calculate();
    compareScenarios(); // Auto-generate scenarios when calculating
  });
  
  // Tab navigation
  document.getElementById("resultsTab").addEventListener("click", () => showTab('results'));
  document.getElementById("compareTab").addEventListener("click", () => showTab('compare'));
  document.getElementById("vehiclesTab").addEventListener("click", () => showTab('vehicles'));
  document.getElementById("leaseTab").addEventListener("click", () => showTab('lease'));

  // Lease calculator
  document.getElementById("calcLeaseBtn").addEventListener("click", calculateLease);
  document.getElementById("addLeaseToCompareBtn").addEventListener("click", addLeaseToComparison);

  // Vehicle comparison
  document.getElementById("addVehicleBtn").addEventListener("click", addVehicleToComparison);

  // Credit score handler
  document.getElementById("creditScore").addEventListener("input", updateCreditTierDisplay);

  // Operating costs toggle
  document.getElementById("includeOperatingCosts").addEventListener("change", function() {
    const show = this.checked;
    document.getElementById("insuranceField").style.display = show ? "block" : "none";
    document.getElementById("maintenanceField").style.display = show ? "block" : "none";
    document.getElementById("registrationField").style.display = show ? "block" : "none";
  });


  // Initialize model dropdown with Hyundai models on page load
  document.getElementById("make").dispatchEvent(new Event("change"));
  
  // Initial calculation (commented out - user should manually calculate)
  // calculate();

  // ================================
  // SERVICE WORKER REGISTRATION (PWA)
  // ================================
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
        .then(registration => {
          console.log('‚úÖ Service Worker registered:', registration.scope);
        })
        .catch(error => {
          console.log('‚ùå Service Worker registration failed:', error);
        });
    });
  }

  // ================================
  // INSTALL PROMPT (PWA)
  // ================================
  let deferredPrompt;
  
  window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent default install prompt
    e.preventDefault();
    deferredPrompt = e;
    
    // Show custom install banner after 5 seconds of use
    setTimeout(() => {
      if (deferredPrompt && !sessionStorage.getItem('installPromptShown')) {
        showInstallPrompt();
      }
    }, 5000);
  });
  
  function showInstallPrompt() {
    const installBanner = document.createElement('div');
    installBanner.id = 'installBanner';
    installBanner.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #6495ED 0%, #8b5cf6 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(100, 149, 237, 0.4);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 16px;
      max-width: 90%;
      animation: slideUp 0.3s ease-out;
    `;
    
    installBanner.innerHTML = `
      <div style="flex: 1;">
        <div style="font-weight: 700; margin-bottom: 4px;">üì± Install This App</div>
        <div style="font-size: 13px; opacity: 0.9;">Add to your home screen for quick access</div>
      </div>
      <button id="installBtn" style="background: white; color: #6495ED; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">Install</button>
      <button id="installDismiss" style="background: none; color: white; border: none; font-size: 24px; cursor: pointer; padding: 0 8px; opacity: 0.7;">√ó</button>
    `;
    
    document.body.appendChild(installBanner);
    
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User ${outcome} the install prompt`);
        deferredPrompt = null;
        installBanner.remove();
        sessionStorage.setItem('installPromptShown', 'true');
      }
    });
    
    document.getElementById('installDismiss').addEventListener('click', () => {
      installBanner.remove();
      sessionStorage.setItem('installPromptShown', 'true');
    });
  }
  
  // Add slideUp animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
  `;
  document.head.appendChild(style);
</script>
</body>
</html>
